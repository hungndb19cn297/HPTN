{"content":"<p>ÄÃ¢y lÃ  bÃ i viáº¿t náº±m trong Series NestJS thá»±c chiáº¿n ğŸ¬, cÃ¡c báº¡n cÃ³ thá»ƒ xem toÃ n bá»™ bÃ i viáº¿t á»Ÿ link ğŸ”—: https://viblo.asia/s/nestjs-thuc-chien-MkNLr3kaVgA</p><hr /><h1 id=\"tvn\">Äáº·t váº¥n Ä‘á» ğŸ“œ</h1><p><img src=\"https://images.viblo.asia/722feef0-1d05-493c-8344-f7aecef60794.png\" alt=\"image.png\" /></p><p>Khi nháº¯c Ä‘áº¿n background job trong NestJS khÃ´ng Ã­t láº§n chÃºng ta Ä‘á»u nghe tá»›i package <strong>Bull</strong> , nÃ³ Ä‘Æ°á»£c dÃ¹ng káº¿t há»£p vá»›i package <strong>@nestjs/bull</strong> Ä‘á»ƒ á»©ng dá»¥ng background job vÃ o source code Nest.</p><p>Tuy nhiÃªn theo sá»± thay Ä‘á»•i tá»« phÃ­a team phÃ¡t triá»ƒn mÃ  hiá»‡n táº¡i <strong>Bull</strong> chá»‰ cÃ²n á»Ÿ maintain mode vÃ  khÃ´ng cÃ²n Ä‘Æ°á»£c phÃ¡t triá»ƒn thÃªm tÃ­nh nÄƒng má»›i. <br/>&gt; \"Bull is currently in maintainance mode, we are only fixing bugs. For new features check BullMQ, a modern rewritten implementation in Typescript. You are still very welcome to use Bull if it suits your needs, which is a safe, battle tested library\". Xem chi tiáº¿t <a href=\"https://www.npmjs.com/package/bull\">á»Ÿ Ä‘Ã¢y</a>.</p><p><img src=\"https://images.viblo.asia/9916363b-68f6-4989-bbfc-71a0709deb13.png\" alt=\"image.png\" /></p><p>á» thá»i Ä‘iá»ƒm hiá»‡n táº¡i cá»§a bÃ i viáº¿t (12/08/2023) document cá»§a Nest chÆ°a cÃ³ hÆ°á»›ng dáº«n sá»­ dá»¥ng vá»›i <strong>BullMQ</strong> vÃ  cÃ¡c tÃ i liá»‡u trÃªn internet cÅ©ng chá»‰ á»Ÿ má»©c cÆ¡ báº£n. Do Ä‘Ã³ á»Ÿ pháº§n nÃ y chÃºng ta sáº½ cÃ¹ng tÃ¬m hiá»ƒu vÃ  sá»­ dá»¥ng package <strong>BullMQ</strong>, Ä‘á»ƒ sau nÃ y náº¿u dá»± Ã¡n cÃ¡c báº¡n tham gia cÃ³ cáº§n sá»­ dá»¥ng cÃ³ thá»ƒ tham kháº£o láº¡i mÃ  khÃ´ng cáº§n pháº£i máº¥t thá»i gian tÃ¬m kiáº¿m.</p><h1 id=\"thngtinpackage\">ThÃ´ng tin package ğŸ“¦ï¸</h1><ul><li>\"bullmq\": \"^3.15.8\"</li><li>\"@nestjs/bullmq\": \"^10.0.0\"</li></ul><p>Source code cá»§a pháº§n nÃ y sáº½ náº±m á»Ÿ <a href=\"https://github.com/nntwelve/Boilerplate-NestJS/tree/part-8-background-job-with-bullmq\">branch part-8-background-job-with-bullmq</a> cÃ¡c bÃ¡n cÃ³ thá»ƒ táº£i vá» Ä‘á»ƒ sá»­ dá»¥ng.</p><h2 id=\"1cit\">1. CÃ i Ä‘áº·t ğŸ› </h2><p>Tiáº¿n hÃ nh cÃ i Ä‘áº·t vá»›i lá»‡nh: </p><p><code>npm i --save @nestjs/bullmq bullmq</code></p><h2 id=\"2cuhnh\">2. Cáº¥u hÃ¬nh ğŸ”©ğŸ”§</h2><p>TÆ°Æ¡ng tá»± vá»›i <strong>Bull</strong>, <strong>BullMQ</strong> cÅ©ng sá»­ dá»¥ng <strong>Redis</strong> nÃªn chÃºng ta cáº§n start lÃªn má»›i cÃ³ thá»ƒ sá»­ dá»¥ng. ThÃªm vÃ o service trong file <code>docker-compose</code>. MÃ¬nh sáº½ dÃ¹ng thÃªm <code>redis-commander</code> Ä‘á»ƒ monitoring cÅ©ng nhÆ° thao tÃ¡c vá»›i dá»¯ liá»‡u trÃªn Redis dá»… dÃ ng hÆ¡n. </p><pre><code class=\"docker-compose.yml language-docker-compose.yml\">...<br/>    flash_cards_redis:<br/>        container_name: flash_cards_redis<br/>        image: redis:alpine<br/>        expose:<br/>          - 6379<br/>        ports:<br/>          - 6379:6379 # Public port Ä‘á»ƒ lÃ¡t ná»¯a test multiple worker<br/>        restart: unless-stopped<br/>    flash_cards_redis_commander:<br/>        container_name: flash_cards_redis_commander<br/>        image: rediscommander/redis-commander:latest<br/>        environment:<br/>          - REDIS_HOSTS=local:flash_cards_redis:6379<br/>        ports:<br/>          - '8088:8081'<br/>        depends_on:<br/>          - flash_cards_redis<br/>  ...<br/></code></pre><pre><code class=\"shell:.env language-shell:.env\">...<br/>REDIS_PORT=6379<br/>REDIS_HOST=flash_cards_redis<br/>...<br/></code></pre><p>Tiáº¿n hÃ nh start 2 service trÃªn: <code>docker compose up -d</code></p><p>Sau khi Ä‘Ã£ cÃ³ <strong>Redis</strong> chÃºng ta sáº½ tiáº¿n hÃ nh cáº¥u hÃ¬nh <strong>BullMQ</strong> trong <code>AppModule</code></p><pre><code class=\"typescript:src/app.module.ts language-typescript:src/app.module.ts\">import { BullModule } from '@nestjs/bullmq';<br/>@Module({<br/>    imports: [<br/>        ...<br/>        BullModule.forRootAsync({<br/>            inject: [ConfigService],<br/>            useFactory: async (configService: ConfigService) =&amp;gt; ({<br/>                connection: {<br/>                    host: configService.get('REDIS_HOST'),<br/>                    port: configService.get('REDIS_PORT'),<br/>                },<br/>            }),<br/>        }),<br/>    ...<br/></code></pre><p>ÄÃ¢y lÃ  <strong>khÃ¡c biá»‡t Ä‘áº§u tiÃªn so vá»›i Bull</strong>, chÃºng ta dÃ¹ng <code>connection</code> thay vÃ¬ <code>redis</code> nhÆ° trong doc cá»§a Nest:</p><p><img src=\"https://images.viblo.asia/921b09ba-88b7-4c23-b4e5-6d17c49baeaf.png\" alt=\"image.png\" /></p><p>Viá»‡c cáº¥u hÃ¬nh chá»‰ Ä‘Æ¡n giáº£n váº­y thÃ´i, <strong>náº¿u</strong> báº¡n nÃ o <strong>gáº·p lá»—i thÃ¬</strong> kháº£ nÄƒng cao lÃ  do káº¿t ná»‘i tá»›i redis chÆ°a chÃ­nh xÃ¡c. <strong>Kiá»ƒm tra láº¡i biáº¿n mÃ´i trÆ°á»ng</strong> cÅ©ng nhÆ° <strong>xem redis Ä‘Ã£ start thÃ nh cÃ´ng hay chÆ°a</strong>.  </p><h2 id=\"3tmhiuvlifecycle\">3. TÃ¬m hiá»ƒu vá» lifecycle ğŸ§¬</h2><p>Äá»ƒ hiá»ƒu tÆ°á»ng táº­n hÆ¡n vá» <strong>BullMQ</strong>, nhÆ° thÆ°á»ng lá»‡ chÃºng ta sáº½ tÃ¬m hiá»ƒu vá» <strong>Lifecycle</strong> cá»§a nÃ³ trong quÃ¡ trÃ¬nh xá»­ lÃ½ Job. </p><p><img src=\"https://images.viblo.asia/dca0315c-2c00-420b-b446-10e429df2bdd.png\" alt=\"\" /></p><p>ChÃº thÃ­ch:</p><ul><li>Khi má»™t Job Ä‘Æ°á»£c thÃªm vÃ o queue bá»Ÿi method <code>add</code>, tÃ¹y theo cÃ¡c option mÃ  sáº½ thuá»™c má»™t trong 3 state sau:<ul><li><strong>wait</strong>: danh sÃ¡ch <strong>cÃ¡c Job vá»«a Ä‘Æ°á»£c add</strong> vÃ  Ä‘ang chá» Ä‘Æ°á»£c chuyá»ƒn sang tráº¡ng thÃ¡i <strong>active</strong>. CÃ¡c <strong>Job bá»‹ lá»—i</strong> trong khi <strong>active</strong> vÃ  cÃ³ <strong>cáº¥u hÃ¬nh retry</strong> cÅ©ng sáº½ Ä‘Æ°á»£c Ä‘Æ°a vá» state nÃ y Ä‘á»ƒ chá» thá»­ láº¡i. </li><li><strong>delayed</strong>: Ä‘ang chá» Ä‘á»ƒ Ä‘Æ°á»£c xá»­ lÃ½, sau khi chá» xong sáº½ chuyá»ƒn sang <strong>wait</strong>, thÆ°á»ng tháº¥y khi sá»­ dá»¥ng option <code>delay</code>. CÃ¡c <strong>Job bá»‹ lá»—i</strong> trong khi <strong>active</strong> vÃ  cÃ³ <strong>cáº¥u hÃ¬nh retry vá»›i back-off strategy</strong> cÅ©ng sáº½ Ä‘Æ°á»£c Ä‘Æ°a trá»Ÿ vá» state nÃ y, chá» trÆ°á»›c khi Ä‘Æ°á»£c chuyá»ƒn sang <strong>wait</strong> Ä‘á»ƒ thá»­ láº¡i.</li><li><strong>prioritized</strong>: biá»ƒu thá»‹ cÃ¡c <strong>Job cÃ³ priority cao</strong> sáº½ <strong>Ä‘Æ°á»£c xá»­ lÃ½ trÆ°á»›c</strong>, thÆ°á»ng tháº¥y khi sá»­ dá»¥ng vá»›i option <code>priority</code>. State nÃ y theo mÃ¬nh tÃ¬m hiá»ƒu thÃ¬ cÆ¡ cháº¿ sau khi add cÅ©ng sáº½ tÆ°Æ¡ng tá»± nhÆ° status <strong>wait</strong> vÃ  chá»‰ thÃªm key priority. CÃ³ láº½ Ä‘Ã³ lÃ  lÃ½ do táº¡i sao giÃ¡ trá»‹ Ä‘áº§u tiÃªn truyá»n vÃ o method <code>getJobs</code> khÃ´ng cÃ³ value <code>priority</code> (hÃ¬nh dÆ°á»›i), thay vÃ o Ä‘Ã³ chÃºng ta pháº£i dÃ¹ng value <code>wait</code> Ä‘á»ƒ láº¥y ra káº¿t quáº£ cÃ³ nÃ³. Má»™t lÆ°u Ã½ khÃ¡c lÃ  <strong>priorities</strong> báº¯t Ä‘áº§u <strong>tá»« 0 Ä‘áº¿n 2^21</strong> vÃ  <strong>0 lÃ  Æ°u tiÃªn cao nháº¥t</strong>.</li></ul></li></ul><p><img src=\"https://images.viblo.asia/15e72fff-e570-488c-b2ea-fd718e1693d6.png\" alt=\"image.png\" /></p><ul><li>Tiáº¿p sau 3 state trÃªn lÃ  <strong>active</strong> lÃ  táº­p há»£p cÃ¡c job Ä‘ang Ä‘Æ°á»£c xá»­ lÃ½. CÃ¡c job á»Ÿ Ä‘Ã¢y sáº½ thá»±c thi Ä‘áº¿n khi nÃ o hoÃ n thÃ nh hoáº·c gáº·p lá»—i.</li><li>Sau cÃ¹ng sáº½ lÃ  má»™t trong 2 tráº¡ng thÃ¡i <strong>completed</strong> hoáº·c <strong>failed</strong> tÃ¹y theo káº¿t quáº£ á»Ÿ state <strong>active</strong>.</li></ul><p>DÆ°á»›i Ä‘Ã¢y lÃ  quÃ¡ trÃ¬nh xá»­ lÃ½ cÃ¡c job á»©ng vá»›i cÃ¡c config khÃ¡c nhau (xem trÃªn redis-commander):</p><ul><li><p>â›“ï¸ğŸš€ QuÃ¡ trÃ¬nh (thá»© tá»±) má»™t Job Ä‘Æ°á»£c xá»­ lÃ½ Ä‘Æ¡n giáº£n hoáº·c dÃ¹ng option <strong>priority</strong> nhÆ° sau: </p><p><em>added</em> â¡ï¸ <em>waiting</em> â¡ï¸ <em>active</em> â¡ï¸ <em>completed</em> â¡ï¸ <em>drained</em></p></li></ul><p><img src=\"https://images.viblo.asia/b6292229-3f64-4626-a34d-9871153233c4.png\" alt=\"image.png\" /></p><ul><li><p>â›“ï¸â³ QuÃ¡ trÃ¬nh má»™t Job Ä‘Æ°á»£c xá»­ lÃ½ vá»›i option <strong>delay</strong> nhÆ° sau:</p><p><em>added</em> â¡ï¸ <strong><em>delayed</em></strong> â¡ï¸ <em>waiting</em> â¡ï¸ <em>active</em> â¡ï¸ <em>completed</em> â¡ï¸ <em>drained</em></p></li></ul><p><img src=\"https://images.viblo.asia/6f0d28b7-10a8-4ab8-9fcf-d41144cde348.png\" alt=\"image.png\" /></p><p>.</p><ul><li><p>â›“ï¸ğŸ” QuÃ¡ trÃ¬nh má»™t Job cÃ³ lá»—i trong quÃ¡ trÃ¬nh xá»­ lÃ½ vá»›i Back-off strategy nhÆ° sau:</p><p><em>added</em> â¡ï¸ <em>waiting</em> â¡ï¸ <strong><em>active</em></strong> â¡ï¸ <strong><em>delayed</em></strong> â¡ï¸ <em>waiting</em> â¡ï¸ <em>active</em> â¡ï¸ <strong><em>failed</em></strong> â¡ï¸ <em>retries exhausted</em> â¡ï¸ <em>drained</em></p></li></ul><p><img src=\"https://images.viblo.asia/823e724c-a90b-41dc-bd49-54a3c8cb2dc7.png\" alt=\"image.png\" /></p><h2 id=\"4cchsdngcbn\">4.CÃ¡ch sá»­ dá»¥ng cÆ¡ báº£n ğŸ’¡</h2><p>Pháº§n nÃ y chÃºng ta sáº½ láº¥y vÃ­ dá»¥ vá»›i <strong>module flash-card</strong>, khi user táº¡o flash-card má»›i sáº½ cÃ³ property image lÃ m hÃ¬nh minh há»a, náº¿u chÃºng ta <strong>lÆ°u trá»±c tiáº¿p image</strong> Ä‘Ã³ vÃ o mÃ  khÃ´ng xá»­ lÃ½ thÃ¬ sáº½ <strong>gÃ¢y hao tá»‘n tÃ i nguyÃªn</strong> trong trÆ°á»ng há»£p nhá»¯ng <strong>image cÃ³ dung lÆ°á»£ng lá»›n</strong>. Do Ä‘Ã³ Ä‘á»ƒ tá»‘i Æ°u chÃºng ta cáº§n <strong>tiá»n xá»­ lÃ½</strong> Ä‘á»ƒ <strong>giáº£m bá»›t dung lÆ°á»£ng</strong> cá»§a image trÆ°á»›c khi lÆ°u vÃ o server, mÃ¬nh sáº½ gá»i lÃ  <strong>optimize image</strong> cho ngáº¯n gá»n.</p><h3 id=\"41queue\">4.1 Queue ğŸ“§ğŸ“§ğŸ“§</h3><p>&gt; Vá» máº·t khÃ¡i niá»‡m thÃ¬ queue chÃ­nh lÃ  má»™t waiting list (hÃ ng chá») chá»©a cÃ¡c job Ä‘ang chá» Ä‘á»ƒ Ä‘Æ°á»£c xá»­ lÃ½. KhÃ¡i niá»‡m nÃ y tÆ°Æ¡ng tá»± vá»›i khÃ¡i niá»‡m queue cÃ¡c báº¡n thÆ°á»ng tháº¥y á»Ÿ cÃ¡c message broker khÃ¡c.</p><p>Äá»ƒ implement logic trÃªn mÃ¬nh sáº½ táº¡o ra 1 queue Ä‘á»ƒ lÆ°u trá»¯ cÃ¡c job dÃ¹ng cho viá»‡c optimize image á»Ÿ <strong>FlashCardModule</strong>:</p><pre><code class=\"typescript:src/modules/flash-cards/flash-cards.module.ts language-typescript:src/modules/flash-cards/flash-cards.module.ts\">import { BullModule } from '@nestjs/bullmq';<br/>...<br/>@Module({<br/>    imports: [<br/>        ...<br/>        BullModule.registerQueue({<br/>            name: 'image:optimize',<br/>            prefix: 'flash-cards'<br/>        })<br/>    ]<br/>    ...<br/>export class FlashCardModule {}<br/></code></pre><p>CÃ³ nhiá»u option chÃºng ta cÃ³ thá»ƒ truyá»n vÃ o queue, á»Ÿ Ä‘Ã¢y thÆ°á»ng mÃ¬nh sáº½ sá»­ dá»¥ng:</p><ul><li><strong>name</strong>: lÃ  tÃªn cá»§a Queue, <strong>báº¯t buá»™c pháº£i cÃ³</strong> Ä‘á»ƒ processor cÃ³ thá»ƒ nháº­n biáº¿t.</li><li><strong>prefix</strong>: dÃ¹ng thÃªm vÃ o tiá»n tá»‘ cho cÃ¡c job trong Queue nÃ y.</li><li><strong>connection</strong>: dÃ¹ng chá»‰ Ä‘á»‹nh káº¿t ná»‘i Ä‘áº¿n má»™t redis cá»¥ thá»ƒ trong trÆ°á»ng há»£p Ä‘ang káº¿t ná»‘i Ä‘áº¿n nhiá»u redis cÃ¹ng lÃºc. </li><li><strong>processor</strong>: thÆ°á»ng Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ cháº¡y Sandbox processor, chÃºng ta sáº½ nÃ³i Ä‘á»ƒ sau.</li></ul><p>Sau khi Ä‘Ã£ register queue xong, chÃºng ta cÃ³ thá»ƒ vÃ o Ä‘á»ƒ xem BullMQ cáº¥u trÃºc nÃ³ nhÆ° tháº¿ nÃ o trong <strong>redis</strong> thÃ´ng qua <strong>redis-commander</strong> chÃºng ta vá»«a cÃ i Ä‘áº·t khi náº£y. MÃ¬nh cháº¡y nÃ³ á»Ÿ port 8088 nÃªn sáº½ truy cáº­p http://localhost:8088. </p><p><img src=\"https://images.viblo.asia/9f032f3f-9aac-486e-8478-122348be6b85.png\" alt=\"image.png\" /></p><p>CÃ³ thá»ƒ tháº¥y hÃ¬nh trÃªn Ä‘Æ°á»£c biá»ƒu thá»‹ dÆ°á»›i dáº¡ng nhÆ° cáº¥u trÃºc tree folder. </p><ul><li>Äáº§u tiÃªn lÃ  flash-cards tá»« config <code>prefix</code>.</li><li>Nhá» vÃ o option <code>name</code> phÃ­a trÃªn cÃ³ sá»­ dá»¥ng tÃ­nh nÄƒng gá»i lÃ  key namespace (syntax <code>:</code>) trong redis, giÃºp cho cáº¥u trÃºc cá»§a chÃºng ta Ä‘Æ°á»£c phÃ¢n chia rÃµ rÃ ng hÆ¡n . Viá»‡c nÃ y giÃºp chÃºng ta cÃ³ thá»ƒ dá»… dÃ ng monitoring vÃ  debugging.</li></ul><h3 id=\"42job\">4.2 Job ğŸ“§</h3><p>Khi Ä‘Ã£ cÃ³ queue rá»“i thÃ¬ chÃºng ta chá»‰ cáº§n thao tÃ¡c thÃªm job vÃ o trong, Ä‘á»ƒ lÃ m viá»‡c Ä‘Ã³ mÃ¬nh sáº½ thÃªm logic vÃ o trong <strong>FlashCardService</strong>. Khi nháº­n Ä‘c image thÃ¬ chÃºng ta sáº½ tiáº¿n hÃ nh add job vÃ o queue.</p><pre><code class=\"typescript:src/modules/flash-cards/flash-cards.service.ts language-typescript:src/modules/flash-cards/flash-cards.service.ts\">import { InjectQueue } from '@nestjs/bullmq';<br/>import { Queue } from 'bullmq';<br/>...<br/>@Injectable()<br/>export class FlashCardsService extends BaseServiceAbstract&amp;lt;FlashCard&amp;gt; {<br/>    constructor(<br/>        ...<br/>        @InjectQueue('image:optimize')<br/>        private readonly image_optimize_queue: Queue,<br/>    ) {<br/>        super(flash_cards_repository);<br/>    }<br/>    async createFlashCard(<br/>        create_dto: CreateFlashCardDto,<br/>        file: Express.Multer.File,<br/>    ): Promise&amp;lt;FlashCard&amp;gt; {<br/>        const flash_card = await this.flash_cards_repository.create(create_dto);<br/>        // ğŸ”½ ThÃªm á»Ÿ Ä‘Ã¢y<br/>        await this.image_optimize_queue.add('optimize-size', {<br/>            file,<br/>            id: flash_card._id,<br/>        });<br/>        return flash_card;<br/>    }<br/>}<br/></code></pre><p>Giáº£i thÃ­ch:</p><ul><li>NhÆ° cÃ¡c báº¡n tháº¥y chÃºng ta dÃ¹ng <code>InjectQueue</code> vá»›i giÃ¡ trá»‹ Ä‘Æ°á»£c truyá»n vÃ o lÃ  value cá»§a option <code>name</code> á»Ÿ bÆ°á»›c trÆ°á»›c Ä‘Ã³ Ä‘á»ƒ inject queue vá»«a register á»Ÿ module. <strong>LÆ°u Ã½</strong> ráº±ng dÃ¹ chÃºng ta cÃ³ <strong>config <code>prefix</code></strong> á»Ÿ <strong>bÆ°á»›c register</strong> nhÆ°ng option Ä‘Ã³ <strong>khÃ´ng liÃªn quan</strong> Ä‘áº¿n pháº§n nÃ y.</li><li>Trong method cá»§a service chÃºng ta sáº½ dÃ¹ng <strong>method <code>add</code></strong> Ä‘á»ƒ thÃªm job vÃ o Queue. Method nÃ y nháº­n vÃ o <strong>3 tham sá»‘</strong>:<ul><li>Tham sá»‘ Ä‘áº§u tiÃªn lÃ  <strong>name</strong> cá»§a job, thÆ°á»ng dÃ¹ng khi xá»­ lÃ½ logic trong 1 queue cÃ³ nhiá»u trÆ°á»ng há»£p xáº£y ra. </li><li>Tham sá»‘ thá»© 2 lÃ  <strong>data</strong> chá»©a cÃ¡c data liÃªn quan dÃ¹ng cho xá»­ lÃ½ job, á»Ÿ Ä‘Ã¢y chÃºng ta sáº½ truyá»n vÃ o image cáº§n optimize vÃ  id cá»§a flash card Ä‘á»ƒ lÆ°u image vÃ o sau khi Ä‘Ã£ xá»­ lÃ½</li><li>Tham sá»‘ cuá»‘i cÃ¹ng lÃ  <strong>opts</strong> hay <strong>job options</strong>, sáº½ dÃ¹ng Ä‘á»ƒ cáº¥u hÃ¬nh cÃ¡c option nhÆ°: <code>delay</code>, <code>priority</code>, <code>back-off</code>,â€¦ mÃ  chÃºng ta Ä‘Ã£ nÃ³i Ä‘áº¿n á»Ÿ pháº§n trÃªn.</li></ul></li></ul><p>CÃ¡c báº¡n nhá»› chá»‰nh sá»­a láº¡i controller Ä‘á»ƒ gá»i Ä‘áº¿n method má»›i cá»§a service. Sau Ä‘Ã³ tiáº¿n hÃ nh gá»i thá»­ API táº¡o flash-card Ä‘á»ƒ kiá»ƒm tra xem job Ä‘Ã£ Ä‘Æ°á»£c thÃªm vÃ o chÆ°a. </p><p><img src=\"https://images.viblo.asia/5f6a77fa-f63b-4054-9b09-370ac38913ba.png\" alt=\"image.png\" /></p><p>CÃ³ thá»ƒ tháº¥y bÃªn trong Ä‘ang cÃ³ má»™t job Ä‘ang á»Ÿ tráº¡ng thÃ¡i <strong>wait</strong> vá»›i giÃ¡ trá»‹ lÃ  1 tÆ°Æ¡ng á»©ng vá»›i job cÃ³ id 1. CÃ¡c báº¡n cÃ³ thá»ƒ báº¥m vÃ o <strong>events</strong> Ä‘á»ƒ chi tiáº¿t nhá»¯ng gÃ¬ Ä‘ang diá»…n ra.</p><p><img src=\"https://images.viblo.asia/60758971-8b4b-4e49-af9c-39ee6dadea7f.png\" alt=\"image.png\" /></p><p>Váº­y lÃ  chÃºng ta Ä‘Ã£ thÃªm Ä‘Æ°á»£c <em>job</em> vÃ o <em>queue</em>, viá»‡c tiáº¿p theo cáº§n lÃ m lÃ  cáº¥u hÃ¬nh <em>worker</em> Ä‘á»ƒ cÃ³ thá»ƒ láº¥y job tá»« queue ra xá»­ lÃ½.</p><h3 id=\"43worker\">4.3 Worker ğŸ‘·â€â™‚ï¸ ğŸ‘·â€â™€ï¸</h3><p>Äá»ƒ táº¡o <em>worker</em> hay <em>processor</em> chÃºng ta sáº½ dÃ¹ng decorator <code>@Processor</code>, tiáº¿n hÃ nh táº¡o <strong>ImageOptimizationProcessor</strong></p><pre><code class=\"typescript:src/modules/flash-cards/queues/flash-cards.processor.ts language-typescript:src/modules/flash-cards/queues/flash-cards.processor.ts\">import { Processor, WorkerHost } from '@nestjs/bullmq';<br/>import { Logger } from '@nestjs/common';<br/>import { Job } from 'bullmq';<br/>@Processor('image:optimize')<br/>export class ImageOptimizationProcessor extends WorkerHost {<br/>    private logger = new Logger();<br/>    async process(job: Job&amp;lt;any, any, string&amp;gt;, token?: string): Promise&amp;lt;any&amp;gt; {<br/>        switch (job.name) {<br/>            case 'optimize-size':<br/>                const optimzied_image = await this.optimizeImage(job.data);<br/>                console.log({ optimzied_image });<br/>                return optimzied_image;<br/>            default:<br/>                throw new Error('No job name match');<br/>        }<br/>    }<br/>    async optimizeImage(image: unknown) {<br/>        this.logger.log('Processing image....');<br/>        return await new Promise((resolve) =&amp;gt;<br/>            setTimeout(() =&amp;gt; resolve(image), 30000),<br/>        );<br/>    }<br/>}<br/></code></pre><p>Giáº£i thÃ­ch:</p><ul><li>Pháº¡m vi bÃ i viáº¿t nÃ y mÃ¬nh sáº½ khÃ´ng implement logic xá»­ lÃ½ image thay vÃ o Ä‘Ã³ dÃ¹ng setTimeout Ä‘á»ƒ giáº£ láº­p thá»i gian xá»­ lÃ½. </li><li>Äá»ƒ <em>worker</em> cÃ³ thá»ƒ xá»­ lÃ½ Ä‘Ãºng <em>queue</em> chÃºng ta cáº§n truyá»n vÃ o Ä‘Ãºng <em>queue name</em> cho <code>@Processor</code>.</li><li><strong>KhÃ¡c vá»›i Bull</strong>, <strong>BullMQ</strong> sáº½ <strong>khÃ´ng</strong> cÃ²n <strong>dÃ¹ng decorator <code>@Process</code></strong> Ä‘á»ƒ xá»­ lÃ½ cho cÃ¡c <em>job</em> (máº·c Ä‘á»‹nh hoáº·c dá»±a vÃ o <em>job name</em>) mÃ  <strong>thay vÃ o Ä‘Ã³</strong> chÃºng ta pháº£i <strong>extends <code>abstract class WorkerHost</code></strong> sau Ä‘Ã³ <strong>implement logic</strong> cho <strong>method <code>process</code></strong>. VÃ¬ tháº¿ cÅ©ng sáº½ khÃ´ng cÃ²n cÃ¡c method xá»­ lÃ½ riÃªng theo tá»«ng job name nhÆ° Ä‘Ã£ tá»«ng dÃ¹ng vá»›i decorator <code>@Process</code>. Thay vÃ o Ä‘Ã³ BullMQ Ä‘Æ°a ra 2 hÆ°á»›ng giáº£i quyáº¿t sau:<ul><li>DÃ¹ng <strong>switch case</strong> bÃªn trong method <code>process</code> Ä‘á»ƒ xá»­ lÃ½ tÆ°Æ¡ng á»©ng vá»›i tá»«ng <em>job name</em>. </li><li>Táº¡o thÃªm cÃ¡c <em>queue</em> á»©ng vá»›i cÃ¡c <em>job name</em> mÃ  chÃºng ta cáº§n xá»­ lÃ½ (cÃ¡ch nÃ y Ä‘Æ°á»£c khuyÃªn dÃ¹ng hÆ¡n).</li></ul></li></ul><p>&gt; Giáº£i thÃ­ch thÃªm thÃ¬ theo nhÆ° team dev cá»§a Bull thÃ¬ viá»‡c dÃ¹ng <code>@Process</code> á»Ÿ Bull sáº½ gÃ¢y ra nhiá»u confusion do Ä‘Ã³ há» Ä‘Ã£ loáº¡i bá» á»Ÿ BullMQ vÃ  vá» báº£n cháº¥t thÃ¬ logic bÃªn trong <code>@Process</code> cÅ©ng chá»‰ lÃ  dÃ¹ng switch case. Tham kháº£o thÃªm tá»« <a href=\"https://docs.bullmq.io/patterns/named-processor\">docs á»Ÿ Ä‘Ã¢y</a>.</p><p>Äá»ƒ <em>woker</em> cÃ³ thá»ƒ láº¥y <em>job</em> tá»« <em>queue</em> ra Ä‘á»ƒ xá»­ lÃ½ chÃºng ta cáº§n thÃªm nÃ³ vÃ o provider vÃ¬ hiá»‡n táº¡i chÃºng ta chá»‰ vá»«a táº¡o file chá»© chÆ°a káº¿t ná»‘i vÃ o báº¥t ká»³ Ä‘Ã¢u. ÄÃ¢y lÃ  <strong>bÆ°á»›c quan trá»ng</strong>, náº¿u <strong>thiáº¿u bÆ°á»›c nÃ y thÃ¬ <em>worker</em> sáº½ khÃ´ng hoáº¡t Ä‘á»™ng.</strong></p><pre><code class=\"typescript:src/modules/flash-cards/flash-cards.module.ts language-typescript:src/modules/flash-cards/flash-cards.module.ts\">import { ImageOptimizationProcessor } from './queues/flash-cards.processor';<br/>...<br/>@Module({<br/>    ...<br/>    providers: [<br/>        ...<br/>        ImageOptimizationProcessor<br/>    ],<br/>})<br/>export class FlashCardsModule {}<br/></code></pre><p>Save láº¡i vÃ  kiá»ƒm tra káº¿t quáº£ á»Ÿ console, cÃ³ thá»ƒ tháº¥y job Ä‘Ã£ Ä‘Æ°á»£c láº¥y ra xá»­ lÃ½ vÃ  sau 30 giÃ¢y tráº£ vá» káº¿t quáº£.</p><p><img src=\"https://images.viblo.asia/f4d1d7fa-a89f-482d-a88e-9020260d47a1.png\" alt=\"image.png\" /></p><p>Trong quÃ¡ trÃ¬nh job Ä‘Æ°á»£c xá»­ lÃ½ thÃ¬ sáº½ Ä‘Æ°á»£c chuyá»ƒn vÃ o <strong>active</strong> nhÆ° hÃ¬nh dÆ°á»›i</p><p><img src=\"https://images.viblo.asia/eced3914-c240-43cb-95e4-69834ff5afdf.png\" alt=\"image.png\" /></p><p>Sau khi job Ä‘Ã£ xá»­ lÃ½ thÃ nh cÃ´ng thÃ¬ sáº½ náº±m trong <strong>completed</strong></p><p><img src=\"https://images.viblo.asia/41ff9262-2e8d-4429-885b-596c2b2988f7.png\" alt=\"image.png\" /></p><h3 id=\"44concurrencyvmultipleworker\">4.4 Concurrency vÃ  Multiple Worker</h3><p>Máº·c Ä‘á»‹nh má»—i <em>worker</em> chá»‰ xá»­ lÃ½ 1 job trong cÃ¹ng má»™t khoáº£ng thá»i gian, cÃ¡c báº¡n cÃ³ thá»ƒ thá»­ gá»i 2 láº§n sáº½ tháº¥y 1 job Ä‘ang trong <strong>active</strong> vÃ  1 job Ä‘ang trong <strong>wait</strong>.</p><p><img src=\"https://images.viblo.asia/14c79fb9-e0a8-41f8-aac0-a3a222db14bb.png\" alt=\"image.png\" /></p><p>Trong má»™t sá»‘ trÆ°á»ng há»£p chÃºng ta mong muá»‘n tÄƒng sá»‘ lÆ°á»£ng job cháº¡y Ä‘á»“ng thá»i Ä‘á»ƒ Ä‘Ã¡p á»©ng cÃ¡c yÃªu cáº§u nháº¥t Ä‘á»‹nh cá»§a dá»± Ã¡n. Äá»ƒ lÃ m Ä‘Æ°á»£c viá»‡c Ä‘Ã³ chÃºng ta cÃ³ thá»ƒ dÃ¹ng cÃ¡c cÃ¡ch sau:</p><ul><li>DÃ¹ng option <strong>concurrency Ä‘á»ƒ cho phÃ©p worker xá»­ lÃ½ song song nhiá»u job</strong>. Tuy nhiÃªn pháº£i cáº©n tháº­n, náº¿u quÃ¡ nhiá»u job cÃ¹ng cháº¡y mÃ  cáº¥u hÃ¬nh server khÃ´ng Ä‘Ã¡p á»©ng Ä‘Æ°á»£c cÃ³ thá»ƒ phÃ¡t sinh váº¥n Ä‘á».</li><li><strong>TÄƒng thÃªm sá»‘ lÆ°á»£ng worker</strong> cho queue, Bull/BullMQ Ä‘Æ°á»£c thiáº¿t káº¿ theo cáº¥u trÃºc phÃ¢n tÃ¡n nÃªn cÃ¡c thÃ nh pháº§n cá»§a nÃ³ cÃ³ thá»ƒ náº±m riÃªng biá»‡t vá»›i nhau, giÃºp tÄƒng kháº£ nÄƒng má»Ÿ rá»™ng theo chiá»u ngang. á»”n hÆ¡n cÃ¡ch trÃªn nhÆ°ng sáº½ tá»‘n thÃªm chi phÃ­ á»©ng vá»›i cÃ¡c worker.</li><li>Káº¿t há»£p cáº£ 2 cÃ¡ch trÃªn <strong>vá»«a tÄƒng worker vá»«a dÃ¹ng option concurrency</strong>. </li><li>Sá»­ dá»¥ng <strong>Sandboxed processors</strong>, chÃºng ta sáº½ nÃ³i Ä‘áº¿n á»Ÿ pháº§n tiáº¿p theo.</li></ul><p>&gt; Má»—i cÃ¡ch Ä‘á»u cÃ³ Æ°u nhÆ°á»›c Ä‘iá»ƒm riÃªng nÃªn khÃ´ng cÃ³ cÃ¡ch nÃ o lÃ  tá»‘i Æ°u nháº¥t, tÃ¹y thuá»™c theo nhu cáº§u dá»± Ã¡n mÃ  cÃ¡c báº¡n chá»n cÃ¡ch thÃ­ch há»£p nháº¥t.</p><p>ChÃºng ta sáº½ láº§n lÆ°á»£t Ä‘i qua cÃ¡c vÃ­ dá»¥, Ä‘áº§u tiÃªn lÃ  dÃ¹ng option <strong>concurrency</strong></p><pre><code class=\"typescript:src/modules/flash-cards/queues/flash-cards.processor.ts language-typescript:src/modules/flash-cards/queues/flash-cards.processor.ts\">...<br/>@Processor('image:optimize', {<br/>    concurrency: 2, // &amp;lt;=== ThÃªm vÃ o Ä‘Ã¢y<br/>})<br/>export class ImageOptimizationProcessor extends WorkerHost { ... }<br/></code></pre><p>Chá»‰ Ä‘Æ¡n giáº£n váº­y thÃ´i, chÃºng ta sáº½ thá»­ gá»i API 3 láº§n xem chuyá»‡n gÃ¬ sáº½ xáº£y ra. NhÆ° hÃ¬nh bÃªn dÆ°á»›i cÃ³ thá»ƒ tháº¥y Ä‘Æ°á»£c cÃ³ 2 job Ä‘ang active vÃ  1 job Ä‘ang wait, Ä‘Ãºng nhÆ° nhá»¯ng gÃ¬ chÃºng ta muá»‘n. </p><p><img src=\"https://images.viblo.asia/952d19bf-de66-4719-97cc-8ca790db27f5.png\" alt=\"image.png\" /></p><p>VÃ­ dá»¥ tiáº¿p theo lÃ  tÄƒng sá»‘ lÆ°á»£ng worker káº¿t há»£p vá»›i concurrency. MÃ¬nh sáº½ táº¡o má»™t dá»± Ã¡n Nest khÃ¡c lÃ m worker Ä‘á»ƒ minh há»a cho tÃ­nh phÃ¢n tÃ¡n cá»§a Bull/BullMQ. CÃ¡c báº¡n cÃ³ thá»ƒ táº£i vá» source code cá»§a <a href=\"https://github.com/nntwelve/BullMQ-Worker\">worker á»Ÿ Ä‘Ã¢y</a>. Äáº§u tiÃªn nhÆ° á»Ÿ pháº§n cáº¥u hÃ¬nh chÃºng ta táº¡o connect  á»Ÿ AppModule sau Ä‘Ã³ register vÃ o queue cáº§n cho worker cháº¡y. Sau Ä‘Ã³ chÃºng ta cÅ©ng táº¡o file <strong>flash-cards.processor.ts</strong> vÃ  copy toÃ n bá»™ ná»™i dung cá»§a class <strong>ImageOptimizationProcessor</strong> vÃ o.<br/>&gt; Äá»ƒ cho nhanh thÃ¬ code á»Ÿ worker mÃ¬nh khÃ´ng tÃ¡ch ra module flash-card mÃ  viáº¿t tháº³ng bÃªn ngoÃ i luÃ´n.</p><pre><code class=\"typescript:bullmq-worker/src/app.module.ts language-typescript:bullmq-worker/src/app.module.ts\">import { ImageOptimizationProcessor } from './flash-cards.processor';<br/>...<br/>@Module({<br/>  imports: [<br/>    BullModule.forRoot({<br/>      connection: {<br/>        host: 'localhost',<br/>        port: 6379,<br/>      },<br/>    }),<br/>    BullModule.registerQueue({<br/>      name: 'flash-cards',<br/>      prefix: 'flash-cards',<br/>    }),<br/>  ],<br/>  controllers: [AppController],<br/>  providers: [AppService, ImageOptimizationProcessor],<br/>})<br/>export class AppModule {}<br/></code></pre><p>Tiáº¿n hÃ nh start worker vá»›i lá»‡nh <code>npm run start:dev</code>. VÃ¬ má»—i worker hiá»‡n cÃ³ option concurrency lÃ  2 nÃªn chÃºng ta sáº½ gá»i API 5 láº§n Ä‘á»ƒ xem káº¿t quáº£ tÆ°á»ng minh hÆ¡n.</p><p><img src=\"https://images.viblo.asia/e7682281-9a87-4f4a-9a64-9e4a4ff73d08.png\" alt=\"image.png\" /></p><p>Tá»« hÃ¬nh trÃªn cÃ³ thá»ƒ tháº¥y Ä‘Æ°á»£c cÃ³ 4 job Ä‘ang active vÃ  1 job Ä‘ang wait nhÆ° chÃºng ta dá»± Ä‘á»‹nh. ChÃºng ta cÃ³ thá»ƒ thay Ä‘á»•i option <strong>concurrency</strong> á»Ÿ cÃ¡c <em>worker</em> Ä‘á»ƒ cáº¥u hÃ¬nh má»—i <em>worker</em> cÃ³ thá»ƒ cháº¡y sá»‘ lÆ°á»£ng job riÃªng.</p><p>Tuy nhiÃªn á»Ÿ Ä‘Ã¢y cÃ³ má»™t váº¥n Ä‘á», khi chÃºng ta xem console á»Ÿ cÃ¡c worker khÃ´ng biáº¿t Ä‘Æ°á»£c job nÃ o Ä‘ang Ä‘Æ°á»£c xá»­ lÃ½ cÅ©ng nhÆ° job nÃ o vá»«a hoÃ n thÃ nh hoáº·c Ä‘ang gáº·p váº¥n Ä‘á» dáº«n Ä‘áº¿n lá»—i. ChÃºng ta cáº§n má»™t thá»© gÃ¬ Ä‘Ã³ giÃºp monitor quÃ¡ trÃ¬nh xá»­ lÃ½ (lifecyle) <em>job</em>, trÃªn mÃ´i trÆ°á»ng production tÃ¹y theo dá»± Ã¡n cÃ³ thá»ƒ sáº½ cÃ³ ráº¥t nhiá»u job nÃªn náº¿u chá»‰ dá»±a vÃ o <strong>redis-commander</strong> thÃ¬ khÃ´ng Ä‘á»§. ChÃºng ta sáº½ Ä‘áº¿n vá»›i pháº§n tiáº¿p theo Ä‘á»ƒ giáº£i quyáº¿t váº¥n Ä‘á» trÃªn.</p><h3 id=\"45eventlistener\">4.5 Event Listener ğŸ‘‚ğŸ’¬</h3><p>Hiá»ƒu má»™t cÃ¡ch Ä‘Æ¡n giáº£n thÃ¬ má»—i khi 1 job chuyá»ƒn sang tráº¡ng thÃ¡i thÃ¬ nÃ³ sáº½ emit ra má»™t event, chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng cÃ¡c Event Listeners Ä‘á»ƒ láº¯ng nghe cÃ¡c sá»± kiá»‡n Ä‘Ã³.</p><p>TÆ°Æ¡ng tá»± vá»›i Bull thÃ¬ BullMQ cÅ©ng sáº½ cÃ³ 2 loáº¡i:</p><ul><li><strong>Local event listeners</strong>: láº¯ng nghe cÃ¡c sá»± kiá»‡n xáº£y ra trong lifecycle cá»§a job cá»§a riÃªng instance Ä‘Ã³. VÃ­ dá»¥ cá»¥ thá»ƒ trong <strong>worker 1</strong> cá»§a chÃºng ta, khi 1 job Ä‘Æ°á»£c nÃ³ xá»­ lÃ½ thÃ¬ cÃ¡c event cá»§a job Ä‘Ã³ chá»‰ cÃ³ thá»ƒ listen trong <strong>worker 1</strong>, <strong>worker 2</strong> sáº½ khÃ´ng thá»ƒ listen Ä‘Æ°á»£c   </li><li><strong>Global event listeners</strong>: láº¯ng nghe cÃ¡c sá»± kiá»‡n xáº£y ra trong lifecycle cá»§a toÃ n bá»™ instance trong queue. NgÆ°á»£c láº¡i vá»›i á»Ÿ trÃªn chÃºng ta cÃ³ thá»ƒ láº¯ng nghe sá»± kiá»‡n cá»§a cáº£ 2 worker. </li></ul><p>Äá»ƒ trá»±c quan hÆ¡n chÃºng ta sáº½ cÃ¹ng Ä‘i Ä‘áº¿n pháº§n vÃ­ dá»¥ minh há»a bÃªn dÆ°á»›i.</p><h4 id=\"localeventlisteners\"><strong>Local event listeners</strong> ğŸ¡</h4><pre><code class=\"typescript:src/modules/flash-cards/queues/flash-cards.processor.ts language-typescript:src/modules/flash-cards/queues/flash-cards.processor.ts\">import { OnWorkerEvent, Processor, WorkerHost } from '@nestjs/bullmq';<br/>@Processor('image:optimize', {<br/>    concurrency: 2<br/>})<br/>export class ImageOptimizationProcessor extends WorkerHost {<br/>    @OnWorkerEvent('active')<br/>    onQueueActive(job: Job) {<br/>        this.logger.log(`Job has been started: ${job.id}`);<br/>    }<br/>    @OnWorkerEvent('completed')<br/>    onQueueComplete(job: Job, result: any) {<br/>        this.logger.log(`Job has been finished: ${job.id}`);<br/>    }<br/>    @OnWorkerEvent('failed')<br/>    onQueueFailed(job: Job, err: any) {<br/>        this.logger.log(`Job has been failed: ${job.id}`);<br/>        this.logger.log({ err });<br/>    }<br/>    @OnWorkerEvent('error')<br/>    onQueueError(err: any) {<br/>        this.logger.log(`Job has got error: `);<br/>        this.logger.log({ err });<br/>    }<br/>    ...<br/></code></pre><p>Giáº£i thÃ­ch:</p><ul><li><strong>ÄÃ¢y cÅ©ng lÃ  má»™t cáº£i tiáº¿n khÃ¡c so vá»›i Bull</strong>, thay vÃ¬ má»—i tráº¡ng thÃ¡i á»©ng vá»›i 1 decorator, BullMQ gÃ´m láº¡i thÃ nh 1 decorator duy nháº¥t lÃ   <code>OnWorkerEvent</code> vÃ  chÃºng ta chá»‰ cáº§n truyá»n vÃ o tráº¡ng thÃ¡i cáº§n listen.</li><li>á»¨ng vá»›i má»—i state thÃ¬ sáº½ cÃ³ param khÃ¡c nhau Ä‘á»ƒ chÃºng ta cÃ³ thá»ƒ thao tÃ¡c. CÃ²n nhiá»u state khÃ¡c mÃ  mÃ¬nh khÃ´ng thá»ƒ liá»‡t kÃª háº¿t, cÃ¡c báº¡n cÃ³ thá»ƒ xem thÃªm <a href=\"https://api.docs.bullmq.io/interfaces/WorkerListener.html\">á»Ÿ Ä‘Ã¢y</a>.</li></ul><p>Tiáº¿n hÃ nh gá»i API Ä‘á»ƒ kiá»ƒm tra káº¿t quáº£, káº¿t quáº£ á»Ÿ console cá»§a worker 1 nhÆ° bÃªn dÆ°á»›i, cÃ³ thá»ƒ tháº¥y khi xá»­ lÃ½ Ä‘áº¿n tá»«ng tráº¡ng thÃ¡i cá»§a job thÃ¬ cÃ¡c method tÆ°Æ¡ng á»©ng mÃ  chÃºng ta khai bÃ¡o sáº½ Ä‘Æ°á»£c gá»i.</p><p><img src=\"https://images.viblo.asia/14f9c879-1c13-46fd-8aa3-09ef70bf0abf.png\" alt=\"image.png\" /></p><p>VÃ¬ lÃ  local event nÃªn bÃªn worker 2 sáº½ khÃ´ng bá»‹ áº£nh hÆ°á»Ÿng, váº«n hiá»ƒn thá»‹ log nhÆ° lÃºc Ä‘áº§u. Viá»‡c nÃ y giÃºp tÃ¡ch biá»‡t Ä‘Æ°á»£c log giá»¯a cÃ¡c worker giÃºp chÃºng ta dá»… debug hÆ¡n.</p><p><img src=\"https://images.viblo.asia/be02fcb4-da06-4531-96b5-7be6eb5a690b.png\" alt=\"image.png\" /></p><h4 id=\"globaleventlisteners\">Global event listeners ğŸŒ</h4><p>Trong trÆ°á»ng há»£p chÃºng ta cáº§n má»™t listener láº¯ng nghe sá»± kiá»‡n cá»§a táº¥t cáº£ worker thÃ¬ chÃºng ta sáº½ dÃ¹ng decorator <code>OnQueueEvent</code> (á»Ÿ Bull lÃ  <code>OnGlobalQueue*</code>). Tuy nhiÃªn theo nhÆ° document, Ä‘á»ƒ sá»­ dá»¥ng <code>OnQueueEvent</code> chÃºng ta cáº§n Ä‘áº·t nÃ³ trong class Ä‘Æ°á»£c decorate vá»›i decorator <code>QueueEventsListener</code>. á» worker 2 mÃ¬nh sáº½ táº¡o file <strong>app.listener.ts</strong> Ä‘á»ƒ láº¥y vÃ­ dá»¥:</p><pre><code class=\"typescript:bullmq-worker/src/app.listener.ts language-typescript:bullmq-worker/src/app.listener.ts\">import {<br/>  OnQueueEvent,<br/>  QueueEventsHost,<br/>  QueueEventsListener,<br/>} from '@nestjs/bullmq';<br/>import { Logger } from '@nestjs/common';<br/>import { Job } from 'bullmq';<br/>@QueueEventsListener('image:optimize')<br/>export class AppListener extends QueueEventsHost {<br/>  private logger = new Logger(AppListener.name);<br/>  @OnQueueEvent('active')<br/>  onQueueEventActive(job: any) {<br/>    this.logger.log(`Job has been started!`);<br/>    this.logger.log(job);<br/>  }<br/>  @OnQueueEvent('completed')<br/>  onQueueEventCompleted(job: Job, result: any) {<br/>    this.logger.log(`Job has been completed!!`);<br/>  }<br/>}<br/></code></pre><p>TÆ°Æ¡ng tá»± processor, Ä‘á»ƒ cÃ³ thá»ƒ sá»­ dá»¥ng listener chÃºng ta cáº§n thÃªm nÃ³ vÃ o provider</p><pre><code class=\"typescript:bullmq-worker/src/app.module.ts language-typescript:bullmq-worker/src/app.module.ts\">...<br/>import { AppListener } from './app.listener';<br/>@Module({<br/>  ...<br/>  providers: [<br/>    AppService, ImageOptimizationProcessor, AppListener,<br/>  ],<br/>})<br/>export class AppModule {}<br/></code></pre><p>Thá»­ gá»i API 3 láº§n vÃ  xem káº¿t quáº£ á»Ÿ console cá»§a worker 2, tá»« hÃ¬nh dÆ°á»›i cÃ³ thá»ƒ tháº¥y worker 1 xá»­ lÃ½ 1 job, worker 2 xá»­ lÃ½ 1 job vÃ  AppListener cá»§a chÃºng ta Ä‘á» láº¯ng nghe Ä‘Æ°á»£c háº¿t.</p><p><img src=\"https://images.viblo.asia/f3c8c42c-94ff-429e-9033-f355fb200d79.png\" alt=\"image.png\" /></p><p>Dá»±a vÃ o 2 vÃ­ dá»¥ trÃªn thÃ¬ cÃ¡c báº¡n cÃ³ thá»ƒ phÃ¡t triá»ƒn tÃ¹y theo nhu cáº§u cá»§a dá»± Ã¡n Ä‘á»ƒ tá»‘i Æ°u trong viá»‡c monitor quÃ¡ trÃ¬nh cÃ¡c job Ä‘Æ°á»£c xá»­ lÃ½.</p><p>&gt; ChÃºng ta hoÃ n toÃ n cÃ³ thá»ƒ config má»™t Global event listeners riÃªng chá»‰ Ä‘á»ƒ láº¯ng nghe cÃ¡c sá»± kiá»‡n, háº¡n cháº¿ Ä‘Æ°á»£c cÃ¡c váº¥n Ä‘á» khi dÃ¹ng chung vá»›i worker.</p><h3 id=\"46ratelimiting\">4.6 Rate Limiting ğŸš§</h3><p>Äá»‘i vá»›i má»™t sá»‘ loáº¡i dá»± Ã¡n mÃ  trong logic xá»­ lÃ½ job cÃ³ gá»i Ä‘áº¿n service cá»§a khÃ¡ch hÃ ng thÃ¬ chÃºng ta cáº§n chÃº Ã½ vá» táº§n suáº¥t gá»i Ä‘i. </p><p><strong>VÃ­ dá»¥:</strong> Worker cá»§a chÃºng ta cÃ³ cáº¥u hÃ¬nh <strong>concurrency lÃ  200</strong> vÃ  thá»i gian Ä‘á»ƒ má»—i job <strong>xá»­ lÃ½ khoáº£ng 0.5-1s</strong>, bÃ¬nh thÆ°á»ng trong <strong>má»—i 60 giÃ¢y</strong> chÃºng ta chá»‰ cÃ³ <strong>khoáº£ng 100 request</strong> gá»i Ä‘áº¿n service cá»§a há»  (<strong>tá»‘i Ä‘a trong 60 giÃ¢y sáº½ xá»­ lÃ½ Ä‘Æ°á»£c 200 * 2 * 60 = 24000</strong>). Äá»™t nhiÃªn má»™t ngÃ y lÆ°á»£ng truy cáº­p cá»§a ngÆ°á»i dÃ¹ng <strong>tÄƒng Ä‘á»™t biáº¿n</strong>, giáº£ sá»­ server cá»§a chÃºng ta thiáº¿t káº¿ tá»‘i Æ°u nÃªn váº«n cÃ³ thá»ƒ xá»­ lÃ½ á»•n thá»a âœ…, cÃ³ Ä‘iá»u sá»‘ lÆ°á»£ng job <strong>xá»­ lÃ½ trong 60 giÃ¢y</strong> sáº½ <strong>tÄƒng tá»‘i Ä‘a lÃªn 24000 request</strong> âš ï¸. Trong trÆ°á»ng há»£p nÃ y khÃ´ng Ã­t thÃ¬ nhiá»u cÅ©ng sáº½ áº£nh hÆ°á»Ÿng Ä‘áº¿n service cá»§a khÃ¡ch hÃ ng náº¿u nhÆ° há» khÃ´ng thiáº¿t káº¿ tá»‘t, tá»‡ hÆ¡n lÃ  sáº½ gÃ¢y sáº­p service cá»§a khÃ¡ch hÃ ng âŒ. </p><p>Tá»« vÃ­ dá»¥ trÃªn cÃ³ thá»ƒ tháº¥y chÃºng ta cáº§n pháº£i giá»›i háº¡n láº¡i cÃ¡c job xá»­ lÃ½ trong má»™t khoáº£ng thá»i gian Ä‘á»ƒ háº¡n cháº¿ váº¥n Ä‘á» trÃªn. Giáº£i phÃ¡p cho váº¥n Ä‘á» nÃ y lÃ  <strong>Rate Limiting</strong>, chá»©c nÄƒng nÃ y cho phÃ©p Bull/BullMQ chá»‰ xá»­ lÃ½ má»™t sá»‘ lÆ°á»£ng job nháº¥t Ä‘á»‹nh trong má»™t khoáº£ng thá»i gian. CÃ¡ch sá»­ dá»¥ng thÃ¬ chÃºng ta sáº½ thÃªm vÃ o worker nhÆ° sau, mÃ¬nh láº¥y <code>ImageOptimizationProcessor</code> lÃ m vÃ­ dá»¥: <strong>cÃ³ thá»ƒ xá»­ lÃ½ Ä‘á»“ng thá»i 200 job nhÆ°ng tá»‘i Ä‘a trong 60s chá»‰ xá»­ lÃ½ 200 job</strong>.</p><pre><code class=\"typescript:src/modules/flash-cards/queues/flash-cards.processor.ts language-typescript:src/modules/flash-cards/queues/flash-cards.processor.ts\">...<br/>@Processor('image:optimize', {<br/>    concurrency: 200,<br/>    limiter: {<br/>        max: 200,<br/>        duration: 60000,<br/>    },<br/>})<br/>export class ImageOptimizationProcessor extends WorkerHost { ... }<br/></code></pre><pre><code>&amp;gt; **LÆ°u Ã½** theo nhÆ° tÃ i liá»‡u cá»§a BullMQ `The rate limiter is global, so if you have for example 10 workers for one queue with the above settings, still only 10 jobs will be processed by second.`: cÃ³ nghÄ©a lÃ  **rate limiter sáº½ Ã¡p dá»¥ng trÃªn táº¥t cáº£ worker** chá»© khÃ´ng pháº£i cho riÃªng worker nÃ o **máº·c dÃ¹ BullMQ láº¡i yÃªu cáº§u chÃºng ta config theo worker** chá»©** khÃ´ng pháº£i queue** nÃªn khÃ¡ lÃ  khÃ³ hiá»ƒu. Äiá»u chÃºng ta cáº§n lÆ°u Ã½ lÃ  cÃ¡c worker cÃ³ thá»ƒ cÃ³ config rate limiter khÃ¡c nhau. VÃ­ dá»¥ worker 1 config max lÃ  200 nhÆ°ng worker 2 lÃ  250 thÃ¬ sáº½ láº¥y tá»‘i Ä‘a lÃ  250, khÃ´ng quan trá»ng thá»© tá»± start worker.<br/></code></pre><h3 id=\"47sandboxedprocessors\">4.7 Sandboxed Processors</h3><p>Trong quÃ¡ trÃ¬nh sá»­ dá»¥ng Bull/BullMQ sáº½ cÃ³ lÃºc cÃ¡c báº¡n gáº·p lá»—i: <strong><code>Missing lock for job queue...</code></strong> sau Ä‘Ã³ job tá»± restart láº¡i vÃ  cháº¡y láº¡i tá»« Ä‘áº§u (double process).</p><p>Lá»—i nÃ y cÃ³ 2 nguyÃªn nhÃ¢n:</p><ul><li>Node process Ä‘ang xá»­ lÃ½ job bá»‹ terminate (nguyÃªn nhÃ¢n nÃ y Ã­t gáº·p)</li><li>Do job chÃºng ta cáº§n xá»­ lÃ½ quÃ¡ náº·ng, dáº«n Ä‘áº¿n chiáº¿m dá»¥ng ráº¥t nhiá»u CPU lÃ m cho <strong>Event Loop</strong> cá»§a NodeJS bá»‹ <strong>block</strong>, khi Ä‘Ã³ Bull/BullMQ khÃ´ng thá»ƒ renew job lock. Khi khÃ´ng thá»ƒ renew thÃ¬ job sáº½ bá»‹ coi lÃ  <strong>stalled</strong> vÃ  tá»± Ä‘á»™ng restart láº¡i.<br/>&gt; Giáº£i thÃ­ch thÃªm vá» job lock thÃ¬ má»—i job khi Ä‘Æ°á»£c worker láº¥y ra khá»i queue sáº½ Ä‘Æ°á»£c lock láº¡i Ä‘á»ƒ xá»­ lÃ½, trÃ¡nh cÃ¡c worker khÃ¡c láº¡i láº¥y nÃ³ ra. Viá»‡c lock job Ä‘Æ°á»£c xá»­ lÃ½ internal bá»Ÿi <strong>lockDuration</strong> (máº·c Ä‘á»‹nh 30 giÃ¢y) vÃ  <strong>lockRenewTime</strong>, nhÆ°ng á»Ÿ trÃªn do viá»‡c xá»­ lÃ½ tá»‘n quÃ¡ nhiá»u thá»i gian vÃ  chiáº¿m dá»¥ng Event Loop dáº«n Ä‘áº¿n Bull/BullMQ khÃ´ng thá»ƒ renew job lock nÃªn bá»‹ Ä‘Æ°a vÃ o <strong>stalled</strong>.</li></ul><p>Äá»ƒ giáº£i quyáº¿t lá»—i trÃªn chÃºng ta cÃ³ thá»ƒ dÃ¹ng cÃ¡c cÃ¡ch sau:</p><ul><li>Chá»‰nh sá»­a láº¡i logic code Ä‘á»ƒ trÃ¡nh block Event Loop quÃ¡ lÃ¢u, chia thÃ nh cÃ¡c pháº§n nhá» Ä‘á»ƒ xá»­ lÃ½.</li><li>Äiá»u chá»‰nh giÃ¡ trá»‹ cá»§a <strong>lockDuration</strong> vÃ  <strong>lockRenewTime</strong>, theo mÃ¬nh cÃ¡c báº¡n chá»‰ nÃªn dÃ¹ng cÃ¡ch nÃ y khi biáº¿t chÃ­nh xÃ¡c khoáº£ng thá»i gian cáº§n xá»­ lÃ½ cá»§a pháº§n logic Ä‘Ã£ gÃ¢y ra lá»—i Ä‘á»ƒ Ä‘iá»u chá»‰nh phÃ¹ há»£p. Vi dá»¥ logic láº¥y dá»¯ liá»‡u vÃ  xá»­ lÃ½ cáº§n 40 giÃ¢y xá»­ lÃ½ xong, chÃºng ta tÄƒng <strong>lockDuration</strong> lÃªn 45 giÃ¢y thÃ¬ cháº¡y á»•n, nhÆ°ng Ä‘áº¿n lÃºc nÃ o Ä‘Ã³ dá»¯ liá»‡u tÄƒng vÃ  xá»­ lÃ½ cáº§n 50 giÃ¢y má»›i xong thÃ¬ láº¡i pháº£i chá»‰nh sá»­a.</li><li>DÃ¹ng <strong>Sandboxed processors</strong>, theo nhÆ° tÃ i liá»‡u thÃ¬ cÃ¡c worker sáº½ cháº¡y processor trÃªn cÃ¡c process riÃªng nÃªn sáº½ khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n process xá»­ lÃ½ job lock.</li></ul><p>Äá»ƒ láº¥y vÃ­ dá»¥ mÃ¬nh sáº½ chá»‰nh sá»­a láº¡i <code>ImageOptimizationProcessor</code>, cho method <code>optimizeImage</code> thá»±c hiá»‡n loop vÃ  in ra giÃ¡ trá»‹ liÃªn tá»¥c Ä‘á»ƒ gÃ¢y ra lá»—i:</p><pre><code class=\"typescript:src/modules/flash-cards/queues/flash-cards.processor.ts language-typescript:src/modules/flash-cards/queues/flash-cards.processor.ts\">@Processor('image:optimize', {<br/>    // concurrency: 1, // Táº¡m thá»i táº¯t concurrency<br/>    lockDuration: 3000, // Giáº£m lockDuration vá» 3s thay vÃ¬ 30s máº·c Ä‘á»‹nh<br/>})<br/>export class ImageOptimizationProcessor extends WorkerHost {<br/>    ...<br/>    async optimizeImage(image: unknown) {<br/>        // Sáº½ blocking Event Loop â­•ï¸<br/>        for (let index = 0; index &amp;lt; 10e5; index++) {<br/>            const progress = ((index * 100) / 10e5).toFixed(2);<br/>            this.logger.log(`${progress}%`);<br/>        }<br/>        return await new Promise((resolve) =&amp;gt;<br/>            setTimeout(() =&amp;gt; resolve(image), 1000),<br/>        );<br/>    }<br/>}<br/></code></pre><p>Thá»­ gá»i API cÃ¡c báº¡n sáº½ tháº¥y khi cháº¡y thÃ¬ tháº¥y job cháº¡y xong nhÆ°ng váº«n bÃ¡o lá»—i vÃ  tá»± Ä‘á»™ng restart (tÃ¹y theo trÆ°á»ng há»£p cÃ³ thá»ƒ cháº¡y Ä‘Æ°á»£c má»™t pháº§n thÃ¬ bÃ¡o lá»—i vÃ  restart luÃ´n), sau vÃ i láº§n thÃ¬ sáº½ chuyá»ƒn thÃ nh failed nhÆ° hÃ¬nh dÆ°á»›i:</p><p><img src=\"https://images.viblo.asia/ee03c377-7b36-4bbd-a2d8-fa4d8363c04a.png\" alt=\"image.png\" /></p><p>Äá»ƒ giáº£i quyáº¿t Ä‘Æ°á»£c váº¥n Ä‘á» trÃªn mÃ¬nh sáº½ dÃ¹ng <strong>Sandboxed Processors</strong> Ä‘á»ƒ xá»­ lÃ½ theo nhÆ° <a href=\"https://docs.bullmq.io/guide/workers/sandboxed-processors\">tÃ i liá»‡u tá»« BullMQ</a>, táº¡o file <strong>flash-cards.sandbox-processor.ts</strong>. Logic sáº½ khÃ´ng cÃ³ gÃ¬ thay Ä‘á»•i so vá»›i <code>ImageOptimizationProcessor</code>, chá»‰ cÃ³ thay decorator <code>@Processor</code> thÃ nh <code>export default</code>.</p><pre><code class=\"typescript:src/modules/flash-cards/queues/flash-cards.sandbox-processor.ts language-typescript:src/modules/flash-cards/queues/flash-cards.sandbox-processor.ts\">import { Logger } from '@nestjs/common';<br/>import { SandboxedJob } from 'bullmq';<br/>export default async function (job: SandboxedJob) {<br/>    const logger = new Logger('Flash Card Processor');<br/>    switch (job.name) {<br/>        case 'optimize-size':<br/>            const optimzied_image = await optimizeImage(job.data);<br/>            logger.log('DONE');<br/>            return optimzied_image;<br/>        default:<br/>            throw new Error('No job name match');<br/>    }<br/>    async function optimizeImage(image: unknown) {<br/>        for (let index = 0; index &amp;lt; 10e5; index++) {<br/>            const progress = ((index * 100) / 10e5).toFixed(2);<br/>            logger.log(`${progress}%`);<br/>        }<br/>        return await new Promise((resolve) =&amp;gt;<br/>            setTimeout(() =&amp;gt; resolve(image), 1000),<br/>        );<br/>    }<br/>}<br/></code></pre><p>Cáº­p nháº­t láº¡i <code>FlashCardsModule</code> thay tháº¿ <code>ImageOptimizationProcessor</code> thÃ nh processor chÃºng ta vá»«a táº¡o</p><pre><code class=\"typescript:src/modules/flash-cards/flash-cards.module.ts language-typescript:src/modules/flash-cards/flash-cards.module.ts\">import { join } from 'path';<br/>...<br/>@Module({<br/>    imports: [<br/>        ...<br/>        BullModule.registerQueue({<br/>            ...<br/>            processors: [ // âªï¸ ThÃªm vÃ o Ä‘Ã¢y â¬<br/>                {<br/>                    concurrency: 1, // CÃ¡c báº¡n cÃ³ thá»ƒ cáº¥u hÃ¬nh processor cháº¡y Ä‘á»“ng thá»i<br/>                    path: join(__dirname, 'queues/flash-cards.sandbox-processor.js'),<br/>                },<br/>            ],<br/>        }),<br/>    ],<br/>    providers: [<br/>        ...<br/>        // ImageOptimizationProcessor, // &amp;lt;=== Comment Ä‘á»ƒ loáº¡i bá»<br/>    ],<br/>    ...<br/>})<br/>export class FlashCardsModule {}<br/></code></pre><p>Thá»­ gá»i láº¡i vÃ  xem káº¿t quáº£, cÃ³ thá»ƒ tháº¥y job Ä‘Ã£ Ä‘Æ°á»£c cháº¡y thÃ nh cÃ´ng. </p><p><img src=\"https://images.viblo.asia/f2e05f5b-8183-43ed-b10f-0c553c5d67b8.png\" alt=\"image.png\" /></p><p>&gt; LÆ°u Ã½: khi sá»­ dá»¥ng <strong>Sandboxed processors</strong> chÃºng ta sáº½ <strong>khÃ´ng thá»ƒ</strong> sá»­ dá»¥ng <strong>Dependency Injection (vÃ  IoC container)</strong> vÃ¬ Ä‘ang cháº¡y trÃªn forked process. VÃ¬ tháº¿ náº¿u cÃ¡c báº¡n pháº£i tá»± khá»Ÿi táº¡o cÃ¡c dependency náº¿u cáº§n sá»­ dá»¥ng.</p><h3 id=\"48flows\">4.8 Flows</h3><p><img src=\"https://images.viblo.asia/45fdf87d-97d3-4d23-b445-7cd0eb19a81a.png\" alt=\"image.png\" /></p><p>ÄÃ¢y lÃ  má»™t <strong>tÃ­nh nÄƒng hay</strong> vÃ  <strong>chá»‰ cÃ³ trÃªn BullMQ</strong>, chá»©c nÄƒng nÃ y giÃºp chÃºng ta xá»­ lÃ½ cÃ¡c job theo <strong>parent - child relationships</strong>, cÃ³ nghÄ©a lÃ  cÃ¡c job Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a lÃ  <strong>parent</strong> sáº½ á»Ÿ tráº¡ng thÃ¡i chá» (<strong>waiting-children</strong> state) vÃ  nÃ³ chá»‰ Ä‘Æ°á»£c xá»­ lÃ½ khi vÃ  chá»‰ khi <strong>táº¥t cÃ¡c job children</strong> Ä‘Æ°á»£c xá»­ lÃ½ <strong>thÃ nh cÃ´ng</strong>.  </p><p><img src=\"https://images.viblo.asia/bd984254-219f-4886-b830-2afd53bed60a.png\" alt=\"image.png\" /></p><p>Äá»ƒ láº¥y vÃ­ dá»¥ chÃºng ta sáº½ thÃªm vÃ o logic xá»­ lÃ½ image á»Ÿ trÃªn: <em>kiá»ƒm tra image cÃ³ vi pháº¡m chÃ­nh sÃ¡ch vÃ  tiÃªu chuáº©n cá»™ng Ä‘á»“ng hay khÃ´ng</em>. Sau khi quÃ¡ trÃ¬nh kiá»ƒm tra vÃ  optimize image thÃ nh cÃ´ng thÃ¬ sáº½ lÆ°u vÃ o storage service vÃ  cáº­p nháº­t database. </p><p>Theo nhÆ° tÃ i liá»‡u, chÃºng ta sáº½ báº¯t Ä‘áº§u báº±ng viá»‡c táº¡o <strong>FlowProvider</strong>, Ä‘áº§u tiÃªn táº¡m thá»i loáº¡i bá» code liÃªn quan Ä‘áº¿n queue khi náº£y vÃ  register láº¡i vá»›i <code>registerFlowProducer</code> á»Ÿ <code>FlashCardsModule</code></p><pre><code class=\"typescript:src/modules/flash-cards/flash-cards.module.ts language-typescript:src/modules/flash-cards/flash-cards.module.ts\">import { BullModule } from '@nestjs/bullmq';<br/>...<br/>@Module({<br/>    imports: [<br/>        MongooseModule.forFeature([...]),<br/>        // ğŸ”„ Ä‘á»•i registerQueue thÃ nh registerFlowProducer<br/>        BullModule.registerFlowProducer({<br/>            name: 'image:upload',<br/>            prefix: 'flash-cards',<br/>        }),<br/>    ],<br/>    controllers: [FlashCardsController],<br/>    providers: [<br/>        FlashCardsService,<br/>        {<br/>            provide: 'FlashCardsRepositoryInterface',<br/>            useClass: FlashCardsRepository,<br/>        },<br/>    ],<br/>})<br/>export class FlashCardsModule {}<br/></code></pre><p>TÆ°Æ¡ng tá»± á»Ÿ <code>FlashCardsService</code>, chÃºng ta sáº½ thay <code>@InjectQueue</code> báº±ng <code>@InjectFlowProducer</code>, sau Ä‘Ã³ thay Ä‘á»•i logic add <em>job</em> vÃ o <em>queue</em> thÃ nh <em>flows</em></p><pre><code class=\"typescript:src/modules/flash-cards/flash-cards.service.ts language-typescript:src/modules/flash-cards/flash-cards.service.ts\">import { Inject, Injectable } from '@nestjs/common';<br/>import { InjectFlowProducer } from '@nestjs/bullmq';<br/>import { FlowProducer } from 'bullmq';<br/>import { BaseServiceAbstract } from 'src/services/base/base.abstract.service';<br/>import { FlashCard } from './entities/flash-card.entity';<br/>import { FlashCardsRepositoryInterface } from './interfaces/flash-cards.interface';<br/>import { CreateFlashCardDto } from './dto/create-flash-card.dto';<br/>@Injectable()<br/>export class FlashCardsService extends BaseServiceAbstract&amp;lt;FlashCard&amp;gt; {<br/>    constructor(<br/>        @Inject('FlashCardsRepositoryInterface')<br/>        private readonly flash_cards_repository: FlashCardsRepositoryInterface,<br/>        // ğŸ”„<br/>        @InjectFlowProducer('image:upload')<br/>        private readonly image_upload_flow: FlowProducer,<br/>    ) {<br/>        super(flash_cards_repository);<br/>    }<br/>    async createFlashCard(<br/>        create_dto: CreateFlashCardDto,<br/>        file: Express.Multer.File,<br/>    ): Promise&amp;lt;FlashCard&amp;gt; {<br/>        const flash_card = await this.flash_cards_repository.create(create_dto);<br/>        await this.image_upload_flow.add({<br/>            name: 'uploading-image',<br/>            queueName: 'image:upload',<br/>            data: { id: flash_card._id },<br/>            children: [<br/>                {<br/>                    name: 'optimize-size',<br/>                    data: { file },<br/>                    queueName: 'image:optimize',<br/>                    opts: {<br/>                        delay: 1000,<br/>                    },<br/>                },<br/>                {<br/>                    name: 'check-term',<br/>                    data: { file },<br/>                    queueName: 'image:check-valid',<br/>                },<br/>                {<br/>                    name: 'check-policy',<br/>                    data: { file },<br/>                    queueName: 'image:check-valid',<br/>                },<br/>            ],<br/>        });<br/>        return flash_card;<br/>    }<br/>}<br/></code></pre><p>Giáº£i thÃ­ch:</p><ul><li>Cáº¥u trÃºc cá»§a <em>flows</em> sáº½ khÃ¡c vá»›i lÃºc Ä‘áº§u, chÃºng ta sáº½ chá»‰ Ä‘á»‹nh <em>queue</em> cá»§a <strong>parent</strong>  trong lÃºc <code>add</code>. </li><li><strong>name</strong> vÃ  <strong>data</strong> thÃ¬ tÆ°Æ¡ng tá»±, váº«n lÃ  tÃªn <em>job</em> vÃ  dá»¯ liá»‡u truyá»n vÃ o.</li><li><strong>children</strong> chÃ­nh lÃ  danh sÃ¡ch cÃ¡c <strong>children job</strong> cáº§n xá»­ lÃ½. NÃ³ Ä‘Æ°á»£c thiáº¿t káº¿ cÃ¡c element bÃªn trong cÃ³ cáº¥u trÃºc sáº½ tÆ°Æ¡ng tá»± nhÆ° <strong>parent</strong>, vÃ¬ tháº¿ chÃºng ta <strong>cÃ³ thá»ƒ cÃ³ cÃ¡c children bÃªn trong children</strong> Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c job nhá» hÆ¡n.</li><li><strong>opts</strong> bao gá»“m cÃ¡c option tÆ°Æ¡ng tá»± khi dÃ¹ng vá»›i job queue thÃ´ng thÆ°á»ng.</li></ul><p>Tiáº¿n hÃ nh gá»i láº¡i API táº¡o flash-card vÃ  xem káº¿t quáº£ á»Ÿ redis-commander:</p><p><img src=\"https://images.viblo.asia/c98ab32a-7db0-42d1-8326-ac8cef4f1d94.png\" alt=\"image.png\" /></p><p>CÃ³ thá»ƒ tháº¥y á»Ÿ hÃ¬nh trÃªn, cÃ³ 4 job Ä‘Æ°á»£c táº¡o ra tÆ°Æ¡ng á»©ng vá»›i nhá»¯ng gÃ¬ chÃºng ta truyá»n vÃ o method <code>add</code> cá»§a <em>flows</em>: 2 job check policy, 1 job optimize Ä‘ang á»Ÿ tráº¡ng thÃ¡i <strong>wait</strong> vÃ  parent job upload Ä‘ang á»Ÿ tráº¡ng thÃ¡i <strong>waiting-children</strong>. </p><p>Do lÃºc náº£y chÃºng ta Ä‘Ã£ xÃ³a háº¿t worker nÃªn giá» sáº½ láº§n lÆ°á»£t thÃªm láº¡i Ä‘á»ƒ cho chÃºng pick job ra xá»­ lÃ½:</p><pre><code class=\"typescript:src/modules/flash-cards/queues/image-verification.processtor.ts language-typescript:src/modules/flash-cards/queues/image-verification.processtor.ts\">import { OnWorkerEvent, Processor, WorkerHost } from '@nestjs/bullmq';<br/>import { Logger } from '@nestjs/common';<br/>import { Job } from 'bullmq';<br/>@Processor('image:check-valid') // CÃ¡c báº¡n váº«n cÃ³ thá»ƒ cáº¥u hÃ¬nh concurrency vÃ  rate limiter nhÆ° bÃ¬nh thÆ°á»ng<br/>export class ImageVerificationProcessor extends WorkerHost {<br/>    ...<br/>    async process(job: Job&amp;lt;any, any, string&amp;gt;, token?: string): Promise&amp;lt;any&amp;gt; {<br/>        switch (job.name) {<br/>            case 'check-term':<br/>                return await this.checkTerm(job.data);<br/>            case 'check-policy':<br/>                return await this.checkPolicy(job.data);<br/>            default:<br/>                throw new Error('No job name match');<br/>        }<br/>    }<br/>    async checkTerm(image: unknown) {<br/>        // Do something with the job here<br/>        this.logger.log('Start checking term...');<br/>        return await new Promise((resolve) =&amp;gt;<br/>            setTimeout(() =&amp;gt; resolve(true), 5000),<br/>        );<br/>    }<br/>    async checkPolicy(image: unknown) {<br/>        this.logger.log('Start checking policy...');<br/>        return await new Promise((resolve) =&amp;gt;<br/>            setTimeout(() =&amp;gt; resolve(true), 8000),<br/>        );<br/>    }<br/>}<br/></code></pre><pre><code class=\"typescript:src/modules/flash-cards/queues/image-optimization.processor.ts language-typescript:src/modules/flash-cards/queues/image-optimization.processor.ts\">import { OnWorkerEvent, Processor, WorkerHost } from '@nestjs/bullmq';<br/>import { Logger } from '@nestjs/common';<br/>import { Job } from 'bullmq';<br/>@Processor('image:optimize')<br/>export class ImageOptimizationProcessor extends WorkerHost {<br/>    ...<br/>    async process(job: Job&amp;lt;any, any, string&amp;gt;, token?: string): Promise&amp;lt;any&amp;gt; {<br/>        switch (job.name) {<br/>            case 'optimize-size':<br/>                const optimzied_image = await this.optimizeImage(job.data.file);<br/>                return optimzied_image;<br/>            default:<br/>                throw new Error('No job name match');<br/>        }<br/>    }<br/>    async optimizeImage(image: unknown) {<br/>        return await new Promise((resolve) =&amp;gt;<br/>            setTimeout(() =&amp;gt; resolve(image), 10000),<br/>        );<br/>    }<br/>}<br/></code></pre><p>Sau khi cÃ³ 2 worker cho children job, Ä‘á»ƒ worker cÃ³ thá»ƒ láº¥y job ra xá»­ lÃ½ chÃºng ta sáº½ lÃ m tÆ°Æ¡ng tá»± nhÆ° á»Ÿ pháº§n trÆ°á»›c: register queue vÃ  thÃªm vÃ o provider.</p><pre><code class=\"typescript:src/modules/flash-cards/flash-cards.module.ts language-typescript:src/modules/flash-cards/flash-cards.module.ts\">import { ImageOptimizationProcessor } from './queues/image-optimization.processor';<br/>import { ImageVerificationProcessor } from './queues/image-verification.processtor';<br/>...<br/>@Module({<br/>    imports: [<br/>        ...<br/>        BullModule.registerQueue({<br/>            name: 'image:optimize',<br/>            prefix: 'flash-cards',<br/>        }),<br/>        BullModule.registerQueue({<br/>            name: 'image:check-valid',<br/>            prefix: 'flash-cards',<br/>        }),<br/>    ],<br/>    ...<br/>    providers: [<br/>        ...<br/>        ImageOptimizationProcessor,<br/>        ImageVerificationProcessor,<br/>    ],<br/>...<br/></code></pre><p>Save láº¡i vÃ  kiá»ƒm tra káº¿t quáº£:</p><p><img src=\"https://images.viblo.asia/f39220ec-4e56-482a-9cd8-244d01fc6e10.png\" alt=\"image.png\" /></p><p>Táº¡i thá»i Ä‘iá»ƒm táº¥t cáº£ cÃ¡c children job completed, parent job sáº½ chuyá»ƒn tráº¡ng thÃ¡i tá»« <strong>waiting-children</strong> sang <strong>wait</strong>. Váº­y táº¡i sao láº¡i lÃ  <strong>wait</strong> mÃ  khÃ´ng pháº£i lÃ  <strong>active</strong>? NguyÃªn nhÃ¢n Ä‘Æ¡n giáº£n lÃ  do parent job váº«n lÃ  má»™t job thÃ´ng thÆ°á»ng nÃªn chÃºng ta váº«n cáº§n worker Ä‘á»ƒ xá»­ lÃ½. Tiáº¿n hÃ nh táº¡o thÃªm worker Ä‘á»ƒ xá»­ lÃ½ image uploading</p><pre><code class=\"typescript:src/modules/flash-cards/queues/image-uploading.processor.ts language-typescript:src/modules/flash-cards/queues/image-uploading.processor.ts\">import { OnWorkerEvent, Processor, WorkerHost } from '@nestjs/bullmq';<br/>import { Logger } from '@nestjs/common';<br/>import { Job } from 'bullmq';<br/>import { FlashCardsService } from '../flash-cards.service';<br/>@Processor('image:upload')<br/>export class ImageUploadingProcessor extends WorkerHost {<br/>    constructor(private readonly flash_cards_service: FlashCardsService) {<br/>        super();<br/>    }<br/>    ...<br/>    async process(job: Job&amp;lt;any, any, string&amp;gt;, token?: string): Promise&amp;lt;any&amp;gt; {<br/>        switch (job.name) {<br/>            case 'uploading-image':<br/>                const children_results = await job.getChildrenValues();<br/>                let optimzied_image;<br/>                for (const property in children_results) {<br/>                    if (property.includes('image:optimize')) {<br/>                        optimzied_image = children_results[property];<br/>                        break;<br/>                    }<br/>                }<br/>                const uploaded_image = await this.uploadingImageToS3(optimzied_image);<br/>                const uploaded = await this.flash_cards_service.update(job.data.id, {<br/>                    image: `image_url_from_s3_${uploaded_image.originalname}`,<br/>                });<br/>                return uploaded;<br/>            default:<br/>                throw new Error('No job name match');<br/>        }<br/>    }<br/>    async uploadingImageToS3(<br/>        image: Express.Multer.File,<br/>    ): Promise&amp;lt;Express.Multer.File&amp;gt; {<br/>        this.logger.log('Start uploading image to S3...');<br/>        return await new Promise((resolve) =&amp;gt;<br/>            setTimeout(() =&amp;gt; resolve(image), 5000),<br/>        );<br/>    }<br/>}<br/></code></pre><p>Giáº£i thÃ­ch: Ä‘á»ƒ cÃ³ thá»ƒ láº¥y Ä‘Æ°á»£c káº¿t quáº£ tá»« cÃ¡c <strong>children job</strong> chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng method <code>getChildrenValues</code>, tuy nhiÃªn vÃ¬ káº¿t quáº£ cÃ³ dáº¡ng object value nÃªn khi truy xuáº¥t giÃ¡ trá»‹ mÃ¬nh search theo queue name.</p><p>TÆ°Æ¡ng tá»± nhÆ° trÃªn chÃºng ta thÃªm vÃ o <code>FlashCardsModule</code></p><pre><code class=\"typescript:src/modules/flash-cards/flash-cards.module.ts language-typescript:src/modules/flash-cards/flash-cards.module.ts\">import { ImageOptimizationProcessor } from './queues/image-optimization.processor';<br/>...<br/>@Module({<br/>    imports: [<br/>        ...<br/>       BullModule.registerQueue({<br/>            name: 'image:upload',<br/>            prefix: 'flash-cards',<br/>        }),<br/>    ],<br/>    ...<br/>    providers: [<br/>        ...<br/>        ImageOptimizationProcessor<br/>    ],<br/>...<br/></code></pre><p>Ngay sau khi thÃªm vÃ o vÃ  save láº¡i thÃ¬ job Ä‘Æ°á»£c láº¥y xá»­ lÃ½, cÃ¡c báº¡n cÃ³ thá»ƒ kiá»ƒm tra log á»Ÿ console hoáº·c á»Ÿ redis-commander. </p><p><img src=\"https://images.viblo.asia/6b5ece2a-81cd-47da-84f3-388367222d4a.png\" alt=\"image.png\" /></p><p>Váº­y lÃ  chÃºng ta Ä‘Ã£ xong quÃ¡ trÃ¬nh xÃ¢y dá»¥ng má»™t quy trÃ¬nh xá»­ lÃ½ cÃ¡c job cÃ³ quan há»‡ vá»›i nhau báº±ng <em>flows</em>. CÃ³ má»™t vÃ i lÆ°u Ã½ cÃ¡c báº¡n nÃªn Ä‘á»ƒ tÃ¢m khi xÃ³a job:</p><ul><li>CÃ¡ch xÃ³a job:</li></ul><pre><code class=\"typescript language-typescript\">await job.remove();<br/>// or<br/>await queue.remove(job.id);<br/></code></pre><ul><li>Khi parent job bá»‹ remove thÃ¬ cÃ¡c children cÅ©ng sáº½ bá»‹ remove</li><li>Náº¿u má»™t children job bá»‹ remove thÃ¬ parent sáº½ bá» qua nÃ³, vÃ  náº¿u nÃ³ lÃ  job cuá»‘i cÃ¹ng thÃ¬ parent job sáº½ chuyá»ƒn sang tráº¡ng thÃ¡i tiáº¿p theo.</li><li>Náº¿u job báº¥t ká»³ sáº½ bá»‹ xÃ³a bá»‹ khÃ³a, thÃ¬ sáº½ khÃ´ng bá»‹ xÃ³a vÃ  throw ra exception.</li></ul><h3 id=\"49pausevresume\">4.9 Pause â¸ï¸ vÃ  Resume â–¶ï¸</h3><p>Trong má»™t vÃ i trÆ°á»ng há»£p Ä‘áº·c biá»‡t, vÃ­ dá»¥ nhÆ° chÃºng ta sá»­ dá»¥ng service notification cá»§a bÃªn thá»© 3, nhÆ°ng hÃ´m Ä‘Ã³ báº¥t ngá» service Ä‘Ã³ cÃ³ váº¥n Ä‘á» hoáº·c Ä‘ang báº£o trÃ¬ nÃ¢ng cáº¥p dáº«n Ä‘áº¿n khÃ´ng thá»ƒ thá»±c hiá»‡n ngay láº­p tá»©c. Khi Ä‘Ã³ náº¿u job Ä‘Ã³ váº«n cháº¡y sáº½ dáº«n Ä‘áº¿n failed hÃ ng loáº¡t, vÃ¬ tháº¿ chÃºng ta muá»‘n táº¡m dá»«ng xá»­ lÃ½ queue Ä‘Ã³ Ä‘á»ƒ trÃ¡nh cÃ¡c monitor cáº£nh bÃ¡o liÃªn tá»¥c.</p><p>&gt; <strong>LÆ°u Ã½:</strong> job khi Ä‘Ã£ Ä‘Æ°á»£c <strong>active</strong> thÃ¬ sáº½ <strong>khÃ´ng cÃ³ cÃ¡ch nÃ o</strong> Ä‘á»ƒ <strong>pause</strong> hoáº·c <strong>remove</strong>.</p><p>VÃ­ dá»¥ mÃ¬nh táº¡o API Ä‘á»ƒ táº¡m dá»«ng queue optimize:image</p><pre><code class=\"typescript:src/modules/flash-cards/flash-cards.service.ts language-typescript:src/modules/flash-cards/flash-cards.service.ts\">import { InjectFlowProducer, InjectQueue } from '@nestjs/bullmq';<br/>import { FlowProducer, Queue } from 'bullmq';<br/>...<br/>@Injectable()<br/>export class FlashCardsService extends BaseServiceAbstract&amp;lt;FlashCard&amp;gt; {<br/>    constructor(<br/>        ...<br/>        @InjectQueue('image:optimize')<br/>        private readonly image_optimize_queue: Queue,<br/>    ) {<br/>        super(flash_cards_repository);<br/>    }<br/>    async pauseOrResumeQueue(state: string) {<br/>        if (state !== 'RESUME') {<br/>            return await this.image_optimize_queue.pause();<br/>        }<br/>        return await this.image_optimize_queue.resume();<br/>    }<br/>    ...<br/>}<br/></code></pre><pre><code class=\"typescript:src/modules/flash-cards/flash-cards.controller.ts language-typescript:src/modules/flash-cards/flash-cards.controller.ts\">...<br/>export class FlashCardsController {<br/>    ...<br/>    @Patch('queue/state')<br/>    @ApiQuery({<br/>        name: 'state',<br/>        enum: ['PAUSE', 'RESUME'],<br/>    })<br/>    pauseOrResumeQueue(@Query('state') state: string) {<br/>        return this.flash_cards_service.pauseOrResumeQueue(state);<br/>    }<br/>}<br/></code></pre><p>Thá»­ gá»i API trÃªn vá»›i state lÃ  PAUSE, sau Ä‘Ã³ gá»i API táº¡o flash-card Ä‘á»ƒ kiá»ƒm tra káº¿t quáº£:</p><p><img src=\"https://images.viblo.asia/87a68d5b-6d7d-4dce-a188-32a2932d8f03.png\" alt=\"image.png\" /></p><p>CÃ³ thá»ƒ tháº¥y Ä‘Æ°á»£c queue optimize:image xuáº¥t hiá»‡n key <em>pause</em>, queue image:check-valid thÃ¬ váº«n hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng vÃ  do optimize:image Ä‘Ã£ pause nÃªn parent job váº«n sáº½ tiáº¿p tá»¥c chá» á»Ÿ waiting-children. Gá»i láº¡i API vá»›i state RESUME vÃ  xem káº¿t quáº£:</p><p><img src=\"https://images.viblo.asia/94dbd97d-d0da-4553-9959-c74e7a77c046.png\" alt=\"image.png\" /></p><p>Khi queue Ä‘Æ°á»£c resume thÃ¬ ngay láº­p tá»©c job bÃªn trong sáº½ Ä‘Æ°á»£c láº¥y ra vÃ  trá»Ÿ láº¡i flow xá»­ lÃ½ nhÆ° bÃ¬nh thÆ°á»ng. </p><p>&gt; Khi pause queue cÃ¡c báº¡n nhá»› cÃ¢n nháº¯c xem cÃ³ cáº§n rate limiting khÃ´ng, vÃ¬ khi resume thÃ¬ sáº½ cÃ³ hÃ ng loáº¡t job Ä‘Æ°á»£c cháº¡y cÃ³ thá»ƒ dáº«n Ä‘áº¿n váº¥n Ä‘á» nhÆ° mÃ¬nh Ä‘á» cáº­p á»Ÿ pháº§n trÃªn</p><h1 id=\"ktlun\">Káº¿t luáº­n ğŸ“</h1><p>Váº­y lÃ  chÃºng ta Ä‘Ã£ tÃ¬m hiá»ƒu xong vá» cÃ¡ch triá»ƒn khai má»™t background job vá»›i BullMQ tá»« cÃ¡c tÃ­nh nÄƒng cÆ¡ báº£n Ä‘áº¿n cÃ¡c tÃ­nh nÄƒng nÃ¢ng cao. ChÃºng ta cÅ©ng biáº¿t Ä‘Æ°á»£c má»™t vÃ i sá»± khÃ¡c nhau giá»¯a BullMQ vÃ  tiá»n thÃ¢n cá»§a nÃ³ lÃ  Bull. Hy vá»ng bÃ i viáº¿t cÃ³ thá»ƒ giÃºp Ã­ch cho cÃ¡c báº¡n trong tÆ°Æ¡ng lai. Cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ giÃ nh thá»i gian Ä‘á»c bÃ i viáº¿t vÃ  háº¹n gáº·p láº¡i á»Ÿ cÃ¡c bÃ i tiáº¿p theo.</p><h1 id=\"tiliuthamkho\">TÃ i liá»‡u tham kháº£o ğŸ”</h1><ul><li>What is bullmq (no date) BullMQ. Available at: https://docs.bullmq.io/ (Accessed: 12 August 2023). </li><li>Astudilllo, M. (2022) Dividing heavy jobs using BullMQ flows in nodejs, Taskforce.sh Blog. Available at: https://blog.taskforce.sh/splitting-heavy-jobs-using-bullmq-flows/ (Accessed: 12 August 2023). </li><li>Documentation: Nestjs - a progressive node.js framework (no date) NestJS. Available at: https://docs.nestjs.com/techniques/queues (Accessed: 12 August 2023). </li></ul><h1 id=\"changelog\">Change log ğŸ““</h1><ul><li>August 12, 2023: Init document</li></ul>","title":"Setup Boilerplate cho dá»± Ã¡n NestJS - Pháº§n 8: Xá»­ lÃ½ Background job vá»›i BullMQ ğŸ› ï¸","tags":["Job Queue","nestjs","message queue","Boilerplate"],"created_at":1691830800000,"updated_at":1691983324000,"comments":[{"id":56010,"hash_id":"Ny0VGqa0JPA","user_id":91600,"level":0,"points":1,"rated_value":0,"commentable_type":"Post","commentable_id":69966,"in_reply_to_comment":null,"in_reply_to_user":null,"created_at":"2023-08-13T15:04:41+07:00","updated_at":"2023-08-14T08:07:12+07:00","deleted_at":null,"edited_at":"2023-08-13T15:04:42+07:00","contents":"BÃ i viáº¿t quÃ¡ chi tiáº¿t, thank bÃ¡c â™¥ï¸â™¥ï¸â™¥ï¸","contents_short":"BÃ i viáº¿t quÃ¡ chi tiáº¿t, thank bÃ¡c â™¥ï¸â™¥ï¸â™¥ï¸","user":{"data":{"id":91600,"url":"https://viblo.asia/u/Anhkolamgidauanhthe","avatar":"58c8e7f8-601d-4a67-a5f1-124312af4554.jpg","name":"Anhkolamgidauanhthe","username":"Anhkolamgidauanhthe","followers_count":18,"reputation":419,"posts_count":10,"banned_at":null,"level_partner":null}}},{"id":56013,"hash_id":"018J2DqeVYK","user_id":37678,"level":1,"points":0,"rated_value":0,"commentable_type":"Post","commentable_id":69966,"in_reply_to_comment":56010,"in_reply_to_user":"Anhkolamgidauanhthe","created_at":"2023-08-14T08:07:50+07:00","updated_at":"2023-08-14T08:07:50+07:00","deleted_at":null,"edited_at":"2023-08-14T08:07:50+07:00","contents":"Tks bÃ¡c ğŸ˜ Cá»‘ gáº¯ng giÃºp ae hiá»ƒu sÃ¢u háº¿t má»©c cÃ³ thá»ƒ.","contents_short":"Tks bÃ¡c ğŸ˜ Cá»‘ gáº¯ng giÃºp ae hiá»ƒu sÃ¢u háº¿t má»©c cÃ³ thá»ƒ.","user":{"data":{"id":37678,"url":"https://viblo.asia/u/ntngoc96wd","avatar":"c34ff5d5-ad66-40e3-b677-79f5427d5748.JPG","name":"Ngoc Nguyen","username":"ntngoc96wd","followers_count":31,"reputation":765,"posts_count":18,"banned_at":null,"level_partner":null}}}]}
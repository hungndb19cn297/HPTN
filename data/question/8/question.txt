{"content":"<p>Xin chÃ o, mÃ¬nh thÃ­ch viáº¿t ngáº¯n vÃ  Ä‘i tháº³ng váº¥n Ä‘á» ğŸ˜´. á» Ä‘Ã¢y cÃ³ táº¥t cáº£ nhá»¯ng thá»© báº¡n nÃªn biáº¿t vá» Python threading.</p><h1 id=\"1threadinglmg\">1. Threading Ä‘á»ƒ lÃ m gÃ¬?</h1><p><strong>Äá»ƒ xá»­ lÃ½ Ä‘á»“ng thá»i!</strong>Má»™t cÃ¡ch máº·c Ä‘á»‹nh, Python sáº½ xá»­ lÃ½ tá»« trÃªn xuá»‘ng. Do Ä‘Ã³, táº¡i má»™t thá»i Ä‘iá»ƒm chá»‰ cÃ³ má»™t Ä‘oáº¡n mÃ£ Ä‘Æ°á»£c thá»±c thi. Láº¥y vÃ­ dá»¥ Ä‘oáº¡n code sau:</p><pre><code class=\"python language-python\">def process_data(name: str, count: int):<br/>    print(f\"Starting {name}...\")<br/>    for i in range(count):<br/>        print(name, i+1, sep=\": \")<br/>if __name__==\"__main__\":<br/>    process_data(\"Thread-1\", 5)<br/>    process_data(\"Thread-2\", 10)<br/></code></pre><p>á» Ä‘Ã¢y, ta muá»‘n cháº¡y hÃ m <code>process_data</code> 2 láº§n, má»—i láº§n truyá»n vÃ o má»™t tham sá»‘ khÃ¡c nhau. Python sáº½ thá»±c thi tá»« trÃªn xuá»‘ng, tá»©c lÃ  cháº¡y hÃ m nÃ y vá»›i bá»™ tham sá»‘ <code>(\"Thread-1\", 5)</code> trÆ°á»›c, sau khi thá»±c thi xong thÃ¬ báº¯t Ä‘áº§u cháº¡y hÃ m nÃ y vá»›i bá»™ tham sá»‘ <code>(\"Thread-2\", 10)</code>. Káº¿t quáº£ tráº£ ra sáº½ lÃ :</p><pre><code class=\"bash language-bash\">Starting Thread-1...<br/>Thread-1: 1<br/>Thread-1: 2<br/>Thread-1: 3<br/>Thread-1: 4<br/>Thread-1: 5<br/>Starting Thread-2...<br/>Thread-2: 1<br/>Thread-2: 2<br/>Thread-2: 3<br/>Thread-2: 4<br/>Thread-2: 5<br/>Thread-2: 6<br/>Thread-2: 7<br/>Thread-2: 8<br/>Thread-2: 9<br/>Thread-2: 10<br/></code></pre><p>Váº­y náº¿u ta muá»‘n cháº¡y Ä‘á»“ng thá»i hÃ m <code>process_data</code> vá»›i 2 bá»™ tham sá»‘ trÃªn cÃ¹ng 1 lÃºc thÃ¬ sao? Bá»Ÿi rÃµ rÃ ng viá»‡c chá» nhau Ä‘á»ƒ thá»±c thi má»™t cÃ¡ch tuáº§n tá»± á»Ÿ Ä‘Ã¢y lÃ  khÃ´ng cáº§n thiáº¿t. Threading sáº½ giÃºp chÃºng ta xá»­ lÃ½ váº¥n Ä‘á» nÃ y.</p><h1 id=\"2threads\">2. Threads</h1><p>Äá»ƒ cÃ³ thá»ƒ táº¡o nhiá»u threads, ta sáº½ sá»­ dá»¥ng thÆ° viá»‡n <code>threading</code>, 1 thÆ° viá»‡n built-in cá»§a Python. DÆ°á»›i Ä‘Ã¢y lÃ  Ä‘oáº¡n code Ä‘á»ƒ giÃºp hÃ m <code>process_data</code> cÃ³ thá»ƒ cháº¡y Ä‘á»“ng thá»i trong 2 threads khÃ¡c nhau vá»›i thÆ° viá»‡n nÃ y:</p><pre><code class=\"python language-python\">import time<br/>import threading<br/>def process_data(name: str, count: int):<br/>    print(f\"Starting {name}...\")<br/>    for i in range(count):<br/>        print(name, i+1, sep=\": \")<br/>        time.sleep(1)<br/>if __name__==\"__main__\":<br/>    thread_one = threading.Thread(target=process_data, args=(\"Thread-1\", 10))<br/>    thread_two = threading.Thread(target=process_data, args=(\"Thread-2\", 5))<br/>    thread_one.start()<br/>    time.sleep(3)<br/>    thread_two.start()<br/>    thread_one.join()<br/>    thread_two.join()<br/></code></pre><ul><li>Äoáº¡n code <code>threading.Thread()</code> nháº±m táº¡o ra má»™t thead má»›i (= <code>asyncio.create_task</code> khi xá»­ lÃ½ báº¥t Ä‘á»“ng bá»™ vá»›i <code>asyncio</code>). Nhá»› ráº±ng á»Ÿ Ä‘Ã¢y ta má»›i <strong>táº¡o ra</strong> chá»© chÆ°a cháº¡y. </li><li>Thread sáº½ thá»±c sá»± cháº¡y khi gá»i <code>thread_one.start()</code>. </li><li><code>thread_one.join()</code>, viá»‡c gá»i hÃ m nÃ y giÃºp cho chÆ°Æ¡ng trÃ¬nh chá» cho tá»›i khi 2 threads Ä‘Æ°á»£c thá»±c thi xong thÃ¬ má»›i thá»±c hiá»‡n Ä‘oáº¡n code bÃªn dÆ°á»›i (náº¿u cÃ³), =<code>await</code> khi xá»­ lÃ½ báº¥t Ä‘á»“ng bá»™ (mÃ¬nh sáº½ sá»›m ra bÃ i vá» báº¥t Ä‘á»“ng bá»™ nha ğŸ˜).<br/>Khi <code>thread_one</code> Ä‘Æ°á»£c <code>start()</code> vá»›i tham sá»‘ <code>(\"Thread-1\", 10)</code>, nÃ³ sáº½ máº¥t tá»•ng cá»™ng 10s Ä‘á»ƒ cháº¡y xong (do vá»›i má»—i giÃ¡ trá»‹ cá»§a biáº¿n <code>count</code> thÃ¬ sleep 1s). NhÃ¬n vÃ o Ä‘oáº¡n chÆ°Æ¡ng trÃ¬nh á»Ÿ hÃ m <code>main</code>, ta tháº¥y sau khi start <code>thread_one</code> sáº½ chá»‰ chá» nÃ³ 3s, sau Ä‘Ã³ start <code>thread_two</code> nÃªn cháº¯c má»i ngÆ°á»i cÅ©ng dá»… dÃ ng Ä‘oÃ¡n Ä‘Æ°á»£c lÃ  <code>thread_one</code> má»›i cháº¡y Ä‘Æ°á»£c 3s (má»›i in ra Ä‘Æ°á»£c Ä‘áº¿n sá»‘ 3 (trÃªn tá»•ng cá»™ng count=10 sá»‘ cáº§n in) thÃ¬ <code>thread_two</code> chen vÃ o, chiáº¿m quyá»n in. LÃºc nÃ y 2 thread sáº½ cÃ¹ng Ä‘á»“ng thá»i in cÃ¡c giÃ¡ trá»‹ ra mÃ n hÃ¬nh.<br/>Káº¿t quáº£ nhÆ° sau:</li></ul><pre><code class=\"bash language-bash\">Starting Thread-1...<br/>Thread-1: 1<br/>Thread-1: 2<br/>Thread-1: 3<br/>Starting Thread-2...<br/>Thread-2: 1<br/>Thread-1: 4<br/>Thread-2: 2<br/>Thread-1: 5<br/>Thread-2: 3<br/>Thread-1: 6<br/>Thread-2: 4<br/>Thread-1: 7<br/>Thread-2: 5<br/>Thread-1: 8<br/>Thread-1: 9<br/>Thread-1: 10<br/></code></pre><p>TÃ¨n ten, Ä‘Ãºng nhÆ° ká»³ vá»ng!</p><h1 id=\"3khcgbtngb\">3. KhÃ¡c gÃ¬ báº¥t Ä‘á»“ng bá»™?</h1><p>Báº¥t Ä‘á»“ng bá»™ (<strong>asynchronous</strong>) cho phÃ©p xá»­ lÃ½ nhiá»u task <strong>trÃªn cÃ¹ng má»™t thread</strong>, <strong>threading</strong> cho phÃ©p Ä‘áº» ra <strong>nhiá»u thread khÃ¡c nhau</strong> Ä‘á»ƒ cháº¡y song song.<br/>ThÃ´ng thÆ°á»ng, thÃ¬ khi 1 task náº·ng Ä‘ang cháº¡y sáº½ block task khÃ¡c, do Ä‘Ã³ async sáº½ dÃ¹ng 1 cÆ¡ cháº¿ (lÃ  event loop, náº¿u báº¡n khÃ´ng hiá»ƒu thÃ¬ ká»‡ nÃ³ Ä‘i, haha) Ä‘á»ƒ cho phÃ©p 1 task Ä‘ang thá»±c thi nhÆ°ng chÆ°Æ¡ng trÃ¬nh váº«n cÃ³ thá»ƒ <strong>nháº­n task khÃ¡c vá» Ä‘á»ƒ thá»±c thi</strong> (cho phÃ©p nháº­n thui nhÃ¡, cÃ²n váº«n pháº£i chá» task trÆ°á»›c xong Ä‘Ã£, 1 thread mÃ ). CÃ²n threading lÃ  cho phÃ©p xá»­ lÃ½ song song Ä‘á»“ng thá»i luÃ´n.</p><h1 id=\"4lock\">4. Lock</h1><p>HÆ¡i ngÆ°á»£c Ä‘á»i chÃºt, lÃ m cÃ¡ch nÃ o Ä‘á»ƒ chá» 1 thread cháº¡y xong thÃ¬ má»›i cho thread khÃ¡c cháº¡y? (DÃ¹ má»¥c Ä‘Ã­ch thread lÃ  ngÄƒn Ä‘iá»u nÃ y ğŸ˜…). CÃ¢u tráº£ lá»i lÃ  dÃ¹ng <strong>lock</strong> (<code>threading.Lock</code>).<br/>Tuy nhiÃªn trÆ°á»›c khi nghiÃªn cá»©u <strong>lock</strong>, ta tháº¥y cÅ©ng cÃ³ thá»ƒ dÃ¹ng <code>thread.join()</code> Ä‘á»ƒ chá» 1 thread thá»±c thi xong nhÆ° trÃªn mÃ¬nh cÃ³ nÃ³i. <br/>VD Ä‘oáº¡n code sau:</p><pre><code class=\"python language-python\">import time<br/>import threading<br/>def counter(limit: int, name: str):<br/>    for i in range(limit):<br/>        time.sleep(0.5)<br/>        print(name, i+1, sep=\": \")<br/>def task1():<br/>    counter(5, \"T-1\")<br/>def task2():<br/>    counter(5, \"T-2\")<br/>def main():<br/>    thread1 = threading.Thread(target=task1)<br/>    thread2 = threading.Thread(target=task2)<br/>    thread1.start()<br/>    thread1.join()<br/>    thread2.start()<br/>    thread2.join()<br/>if __name__==\"__main__\":<br/>    main()<br/></code></pre><p>Sau khi <code>thread1</code> Ä‘Æ°á»£c <code>start</code>, ta dÃ¹ng <code>thread1.join()</code> Ä‘á»ƒ chá» cho <code>thread1</code> nÃ y thá»±c thi xong thÃ¬ má»›i <code>thread2.start()</code>.<br/>Do Ä‘Ã³, káº¿t quáº£ lÃ :</p><pre><code class=\"bash language-bash\">T-1: 1<br/>T-1: 2<br/>T-1: 3<br/>T-1: 4<br/>T-1: 5<br/>T-2: 1<br/>T-2: 2<br/>T-2: 3<br/>T-2: 4<br/>T-2: 5<br/></code></pre><p>Great! Tuy nhiÃªn, nhiá»u ngÆ°á»i láº¡i khÃ´ng thÃ­ch dÃ¹ng <code>join()</code> (vÃ¬ khÃ´ng cÃ³ <code>join()</code> thÃ¬ code nÃ³ váº«n cháº¡y ğŸ˜). LÃºc nÃ y ta sáº½ dÃ¹ng <code>lock</code> nhÆ° Ä‘oáº¡n code dÆ°á»›i:</p><pre><code class=\"python language-python\">import time<br/>import threading<br/>lock = threading.Lock()<br/>def counter(limit: int, name: str):<br/>    for i in range(limit):<br/>        time.sleep(0.5)<br/>        print(name, i+1, sep=\": \")<br/>def task1():<br/>    lock.acquire()<br/>    counter(5, \"T-1\")<br/>    lock.release()<br/>def task2():<br/>    lock.acquire()<br/>    counter(5, \"T-2\")<br/>    lock.release()<br/>def main():<br/>    thread = threading.Thread(target=task1)<br/>    thread2 = threading.Thread(target=task2)<br/>    thread.start()<br/>    thread2.start()<br/>if __name__==\"__main__\":<br/>    main()<br/></code></pre><ul><li>Trong hÃ m <code>task1</code>, <code>lock.acquire()</code> sáº½ nÃ³i ráº±ng: Ãª, chá»‰ cháº¡y thread nÃ o giá»¯ lock nÃ y thÃ´i nhÃ¡, bao giá» lock nÃ y Ä‘Æ°á»£c <code>release()</code> thÃ¬ má»›i Ä‘áº¿n thread khÃ¡c.</li><li>Trong hÃ m <code>task2</code> cÅ©ng lÃ   <code>acquire()</code> lock nhÆ°ng sáº½ khÃ¡c vá»›i lock cá»§a <code>task1</code> (má»—i láº§n <code>lock.acquire()</code> sáº½ cÃ³ 1 lock khÃ¡c nhau, chá»‰ Ã¡p dá»¥ng vá»›i thread Ä‘Ã³ cho tá»›i khi Ä‘Æ°á»£c <code>release</code> thÃ¬ khÃ´ng cÃ²n ná»¯a).</li><li>LÆ°u Ã½ lÃ  á»Ÿ Ä‘Ã¢y task nÃ o cÅ©ng pháº£i <code>acquire</code> 1 lock thÃ¬ nÃ³ má»›i bá»‹ lock nha, chá»© náº¿u chá»‰ <code>acquire</code> á»Ÿ <code>task1</code> vÃ  bá» á»Ÿ <code>task2</code> thÃ¬ <code>task2</code> sáº½ khÃ´ng bá»‹ lock. Do cÆ¡ cháº¿ cá»§a <code>lock</code> thÃ´i: <code>lock</code> sáº½ Ä‘áº£m báº£o <strong>táº¡i má»™t thá»i Ä‘iá»ƒm chá»‰ cÃ³ 1 thread Ä‘Æ°á»£c giá»¯ lock</strong> vÃ  cháº¡y, do Ä‘Ã³ nÃ³ chá»‰ quáº£n lÃ½ Ä‘Æ°á»£c cÃ¡c thread Ä‘Æ°á»£c gÃ¡n lock, chá»© náº¿u khÃ´ng gÃ¡n lock thÃ¬ nÃ³ cÅ©ng chá»‹u.<br/>Yes, vÃ  Ä‘Ã¢y lÃ  káº¿t quáº£, giá»‘ng há»‡t dÃ¹ng <code>join()</code> dÃ¹ khÃ´ng dÃ¹ng <code>join()</code> ğŸ˜³:</li></ul><pre><code class=\"bash language-bash\">T-1: 1<br/>T-1: 2<br/>T-1: 3<br/>T-1: 4<br/>T-1: 5<br/>T-2: 1<br/>T-2: 2<br/>T-2: 3<br/>T-2: 4<br/>T-2: 5<br/></code></pre><p>Tháº¿ náº¿u ta táº¡o 1 thread má»›i trong chÃ­nh <code>thread2</code> thÃ¬ Ä‘iá»u gÃ¬ sáº½ xáº£y ra? XÃ©t Ä‘oáº¡n code:</p><pre><code class=\"python language-python\">import time<br/>import threading<br/>lock = threading.Lock()<br/>def counter(limit: int, name: str):<br/>    for i in range(limit):<br/>        time.sleep(0.5)<br/>        print(name, i+1, sep=\": \")<br/>def task1():<br/>    lock.acquire()<br/>    counter(5, \"T-1\")<br/>    lock.release()<br/>def task2():<br/>    lock.acquire()<br/>    thread3 = threading.Thread(target=task3)<br/>    thread3.start()<br/>    counter(5, \"T-2\")<br/>    lock.release()<br/>def task3():<br/>    counter(5, \"T-3\")<br/>def main():<br/>    thread = threading.Thread(target=task1)<br/>    thread2 = threading.Thread(target=task2)<br/>    thread.start()<br/>    thread2.start()<br/>if __name__==\"__main__\":<br/>    main()<br/></code></pre><ul><li><code>thread3</code> (cháº¡y <code>task3</code>) Ä‘Æ°á»£c khai bÃ¡o vÃ  <code>start()</code> trong chÃ­nh <code>task2</code>.</li><li>Khi nÃ y, <code>task2</code> vÃ  <code>task3</code> sáº½ cÃ³ thá»ƒ xáº£y ra Ä‘á»“ng thá»i, vÃ  cÃ¹ng giá»¯ lock, trong khi <code>task1</code> thÃ¬ pháº£i Ä‘á»™c láº­p. HÃ£y xem káº¿t quáº£ lÃ  hiá»ƒu ngay:</li></ul><pre><code class=\"bash language-bash\">T-1: 1<br/>T-1: 2<br/>T-1: 3<br/>T-1: 4<br/>T-1: 5<br/>T-3: 1<br/>T-2: 1<br/>T-3: 2<br/>T-2: 2<br/>T-3: 3<br/>T-2: 3<br/>T-3: 4<br/>T-2: 4<br/>T-3: 5<br/>T-2: 5<br/></code></pre><p>OK, khÃ³ hÆ¡n chÃºt nÃ y, Ä‘oáº¡n code dÆ°á»›i Ä‘Ã¢y táº¡o ra má»™t <code>thread</code> cÃ³ <code>acquire</code> lock (lÃ  <code>thread2</code>) trong 1 thread <code>acquire</code> lock (lÃ  <code>thread1</code>). HÃ£y Ä‘oÃ¡n xem Ä‘iá»u gÃ¬ sáº½ xáº£y ra:</p><pre><code class=\"python language-python\">import time<br/>import threading<br/>lock = threading.Lock()<br/>def counter(limit: int, name: str):<br/>    for i in range(limit):<br/>        time.sleep(0.5)<br/>        print(name, i+1, sep=\": \")<br/>def task1():<br/>    lock.acquire()<br/>    thread2 = threading.Thread(target=task2)<br/>    thread2.start()<br/>    counter(5, \"T-1\")<br/>    lock.release()<br/>def task2():<br/>    lock.acquire()<br/>    counter(5, \"T-2\")<br/>    lock.release()<br/>def main():<br/>    thread1 = threading.Thread(target=task1)<br/>    thread1.start()<br/>if __name__==\"__main__\":<br/>    main()<br/></code></pre><p>HÃ£y xem káº¿t quáº£ nhÃ©:</p><pre><code class=\"bash language-bash\">T-1: 1<br/>T-1: 2<br/>T-1: 3<br/>T-1: 4<br/>T-1: 5<br/>T-2: 1<br/>T-2: 2<br/>T-2: 3<br/>T-2: 4<br/>T-2: 5<br/></code></pre><p>ÄÆ¡n giáº£n thÃ´i, <code>thread2</code> cÃ³ <code>acquire</code> lock trong <code>thread1</code> nhÆ°ng mÃ  lock Ä‘ang bá»‹ <code>thread1</code> giá»¯, chÆ°a Ä‘Æ°á»£c <code>release</code> nÃªn nÃ³ pháº£i chá» cho <code>thread1</code> thá»±c thi cho tá»›i khi nÃ³ <code>release</code> lock, rá»“i nÃ³ má»›i cÃ³ lock Ä‘á»ƒ thá»±c thi.<br/>=&gt; Tá»« Ä‘Ã¢y cÃ³ thá»ƒ Ä‘oÃ¡n Ä‘Æ°á»£c lÃ  náº¿u bá» <code>lock.release()</code> trong <code>task1</code> thÃ¬ <code>task2</code> sáº½ khÃ´ng bao giá» cÃ³ cÆ¡ há»™i Ä‘á»ƒ thá»±c thi vÃ  chÆ°Æ¡ng trÃ¬nh sáº½ pháº£i Ä‘á»£i mÃ£i mÃ£i (hÃ£y thá»­ nhÃ©!).</p><h1 id=\"5daemonthread\">5. Daemon Thread</h1><p>LÃ  loáº¡i thread cÃ³ <strong>quyá»n Æ°u tiÃªn tháº¥p</strong>. NÃ³ chá»‰ Ä‘Æ°á»£c giá»¯ Ä‘á»ƒ thá»±c thi khi cÃ³ Ã­t nháº¥t 1 thread Ä‘ang sá»‘ng, cÃ²n khÃ´ng thÃ¬: báº¡n bÃ¨ cháº¿t háº¿t rá»“i, nÃ³ sáº½ cháº¿t theo.<br/>HÃ£y xem Ä‘oáº¡n code táº¡o daemon thread dÆ°á»›i:</p><pre><code class=\"python language-python\">import threading<br/>import time<br/>def infinite_loop():<br/>    while True:<br/>        print(time.time())<br/>        time.sleep(1)<br/>if __name__==\"__main__\":<br/>    thread = threading.Thread(target=infinite_loop, daemon=True)<br/>    thread.start()<br/></code></pre><p>Máº·c Ä‘á»‹nh khi <code>threading.Thread()</code>, ta táº¡o ra 1 thread cÃ³ quyá»n Æ°u tiÃªn cao (<code>daemon=False</code>), nÃªn náº¿u muá»‘n táº¡o daemon thÃ¬ ta chá»‰ Ä‘á»‹nh nhÆ° Ä‘oáº¡n code trÃªn.</p><ul><li>Náº¿u khÃ´ng cÃ³ <code>daemon=True</code>, hÃ m <code>infinite_loop</code> sáº½ in ra thá»i gian sau má»—i 1s vÃ  khÃ´ng bao giá» dá»«ng.</li><li>CÃ²n vá»›i daemon thread nhÆ° trÃªn nÃ³ chá»‰ in ra 1 láº§n, khi thread cháº¡y hÃ m main exit thÃ¬ nÃ³ cÅ©ngâ€¦ nghá»‰ luÃ´n. Káº¿t quáº£ Ä‘Ã¢y:</li></ul><pre><code class=\"bash language-bash\">1691860930.767461<br/></code></pre><h1 id=\"6semaphores\">6. Semaphores</h1><p>Vá»›i <code>lock</code>, ta khiáº¿n chÆ°Æ¡ng trÃ¬nh chá» 1 thread cháº¡y xong trÆ°á»›c khi sang thread khÃ¡c, cÃ²n náº¿u muá»‘n <strong>chá» nhiá»u (n) threads cháº¡y Ä‘á»“ng thá»i xong, trÆ°á»›c khi cháº¡y sang n threads káº¿ tiáº¿p</strong> thÃ¬ sao? =&gt; Ta cÃ³ Semaphores.<br/>Äoáº¡n code dÆ°á»›i Ä‘Ã¢y táº¡o ra 1 Semaphores cho phÃ©p 5 threads cháº¡y Ä‘á»“ng thá»i cÃ¹ng lÃºc:</p><pre><code class=\"python language-python\">import time<br/>import threading<br/>sem = threading.Semaphore(5)<br/>def process_something(id: int):<br/>    sem.acquire()<br/>    print(f\"{id} -&amp;gt; Running!\")<br/>    time.sleep(5)<br/>    print(f\"{id} -&amp;gt; Finished!\")<br/>    sem.release()<br/>if __name__==\"__main__\":<br/>    for i in range(10):<br/>        time.sleep(0.5)<br/>        thread = threading.Thread(target=process_something, kwargs={\"id\": i+1})<br/>        thread.start()<br/></code></pre><p>Ráº¥t giá»‘ng cáº¥u trÃºc <code>acquire-release</code> cá»§a <code>lock</code> Ä‘Ãºng khÃ´ng. Khi cÃ³ báº¥t ká»³ thread nÃ o cháº¡y xong thÃ¬ thread Ä‘ang chá» sáº½ Ä‘Æ°á»£c vÃ o cháº¡y luÃ´n. Do Ä‘Ã³, káº¿t quáº£ sáº½ lÃ :</p><pre><code class=\"bash language-bash\">1 -&amp;gt; Running!<br/>2 -&amp;gt; Running!<br/>3 -&amp;gt; Running!<br/>4 -&amp;gt; Running!<br/>5 -&amp;gt; Running!<br/>1 -&amp;gt; Finished!<br/>6 -&amp;gt; Running!<br/>2 -&amp;gt; Finished!<br/>7 -&amp;gt; Running!<br/>3 -&amp;gt; Finished!<br/>8 -&amp;gt; Running!<br/>4 -&amp;gt; Finished!<br/>9 -&amp;gt; Running!<br/>5 -&amp;gt; Finished!<br/>10 -&amp;gt; Running!<br/>6 -&amp;gt; Finished!<br/>7 -&amp;gt; Finished!<br/>8 -&amp;gt; Finished!<br/>9 -&amp;gt; Finished!<br/>10 -&amp;gt; Finished!<br/></code></pre><p>LÃºc Ä‘áº§u, 5 threads Ä‘Æ°á»£c cháº¡y Ä‘á»“ng thá»i. Sau Ä‘Ã³ cÃ³ 1 threads cháº¡y xong (thread 1), láº­p tá»©c thread tiáº¿p theo Ä‘Æ°á»£c vÃ o (thread 6),â€¦</p><h1 id=\"7contextmanagercholocksemaphores\">7. Context manager cho Lock/Semaphores</h1><p>Äá»ƒ trÃ¡nh quÃªn <code>release</code> má»—i láº§n <code>acquire</code>, dáº«n Ä‘áº¿n chÆ°Æ¡ng trÃ¬nh khÃ´ng thá»ƒ thoÃ¡t Ä‘Æ°á»£c, ta cÃ³ thá»ƒ sá»­ dá»¥ng context manager vá»›i tá»« khÃ³a <code>with</code>. Theo Ä‘Ã³, viá»‡c <code>release</code> sáº½ Ä‘Æ°á»£c tá»± Ä‘á»™ng thá»±c thi chá»«ng nÃ o Ä‘oáº¡n code trong <code>with</code> Ä‘Æ°á»£c cháº¡y xong.<br/>VÃ­ dá»¥ Ä‘oáº¡n code Semaphores phÃ­a trÃªn cÃ³ thá»ƒ Ä‘Æ°á»£c viáº¿t láº¡i nhÆ° sau:</p><pre><code class=\"python language-python\">import time<br/>import threading<br/>sem = threading.Semaphore(5)<br/>def process_something(id: int):<br/>    with sem:<br/>        print(f\"{id} -&amp;gt; Running!\")<br/>        time.sleep(5)<br/>        print(f\"{id} -&amp;gt; Finished!\")<br/>if __name__==\"__main__\":<br/>    for i in range(10):<br/>        time.sleep(0.5)<br/>        thread = threading.Thread(target=process_something, kwargs={\"id\": i+1})<br/>        thread.start()<br/></code></pre><p>Káº¿t quáº£ tráº£ vá» sáº½ khÃ´ng cÃ³ gÃ¬ thay Ä‘á»•i vá»›i viá»‡c dÃ¹ng <code>acquire-release</code>.</p><h1 id=\"8racecondition\">8. Race condition</h1><p>Khi cÃ³ nhiá»u thread cÃ¹ng thay Ä‘á»•i vÃ o 1 biáº¿n global, káº¿t quáº£ cuá»‘i cÃ¹ng cá»§a biáº¿n Ä‘Ã³ sáº½ khÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c, Ä‘Ã¢y chÃ­nh lÃ  race condition. XÃ©t VD sau:</p><pre><code class=\"python language-python\">import threading<br/>import time<br/>lock = threading.Lock()<br/>def edit(operation: str, amount: int, repeat: int):<br/>    global value<br/>    for _ in range(repeat):<br/>        temp: int = value<br/>        time.sleep(0)<br/>        if operation == \"add\":<br/>            temp += amount<br/>        elif operation == \"subtract\":<br/>            temp -= amount<br/>            time.sleep(0)<br/>            value = temp<br/>if __name__==\"__main__\":<br/>    value: int = 0<br/>    adder = threading.Thread(target=edit, args=(\"add\", 100, 1_000_000))<br/>    subtractor = threading.Thread(target=edit, args=(\"subtract\", 100, 1_000_000))<br/>    adder.start()<br/>    subtractor.start()<br/>    adder.join()<br/>    subtractor.join()<br/>    print(f\"{value = }\")<br/></code></pre><p>Káº¿t quáº£ mong muá»‘n lÃ  0 do ta cá»™ng vÃ o biáº¿n <code>value</code> 1,000,000 láº§n giÃ¡ trá»‹ 100 sau Ä‘Ã³ láº¡i trá»« Ä‘i 1,000,000 láº§n giÃ¡ trá»‹ 100.<br/>Tuy nhiÃªn, khi cháº¡y láº¡i cho ra giÃ¡ trá»‹ khÃ´ng báº±ng 0. Tháº­m chÃ­, cÃ¡c láº§n cháº¡y khÃ¡c nhau cho ra giÃ¡ trá»‹ khÃ´ng giá»‘ng nhau.<br/>Äiá»u nÃ y diá»…n ra lÃ  do 2 threads Ä‘ang truy cáº­p song song vÃ o biáº¿n <code>value</code>, Ä‘oáº¡n code <code>sleep</code> khiáº¿n cÃ³ thá»ƒ má»™t phÃ©p cá»™ng chÆ°a thá»±c thi xong, giÃ¡ trá»‹ <code>value</code> chÆ°a Ä‘Æ°á»£c update thÃ¬ phÃ©p trá»« Ä‘Ã£ Ä‘Æ°á»£c thá»±c thi. Do Ä‘Ã³, phÃ©p trá»« khi nÃ y pháº£i thá»±c thi trÃªn giÃ¡ trá»‹ chÆ°a cáº­p nháº­t.<br/>Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y, chÃºng ta sáº½ dÃ¹ng <code>lock</code>:</p><pre><code class=\"python language-python\">import threading<br/>import time<br/>lock = threading.Lock()<br/>def edit(operation: str, amount: int, repeat: int):<br/>    global value<br/>    with lock:<br/>        for _ in range(repeat):<br/>            temp: int = value<br/>            time.sleep(0)<br/>            if operation == \"add\":<br/>                temp += amount<br/>            elif operation == \"subtract\":<br/>                temp -= amount<br/>            time.sleep(0)<br/>            value = temp<br/>if __name__==\"__main__\":<br/>    value: int = 0<br/>    adder = threading.Thread(target=edit, args=(\"add\", 100, 1_000_000))<br/>    subtractor = threading.Thread(target=edit, args=(\"subtract\", 100, 1_000_000))<br/>    adder.start()<br/>    subtractor.start()<br/>    adder.join()<br/>    subtractor.join()<br/>    print(f\"{value = }\")<br/></code></pre><p>Káº¿t quáº£ tráº£ vá» sáº½ luÃ´n báº±ng 0 nhÆ° ká»³ vá»ng.<br/>Cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ Ä‘á»c háº¿t bÃ i nÃ y â˜ºï¸</p><p><strong>Tham kháº£o:</strong></p><ul><li>The Complete Guide To Mastering Python In 2023 - Udemy</li></ul>","title":"Nhá»¯ng Ä‘iá»u cáº§n biáº¿t vá» Threading trong Python","tags":["Advance Python","Multi Threading","parallel programming","Multithread","async"],"created_at":1691868516000,"updated_at":1691983383000,"comments":[]}